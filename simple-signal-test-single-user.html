<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤ - –û–¥–∏–Ω–æ—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .section {
            padding: 25px;
            border-bottom: 1px solid #eee;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e68900;
        }
        
        .hidden {
            display: none !important;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status-idle {
            background: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #4CAF50;
        }
        
        .status-connecting {
            background: #fff3e0;
            color: #f57c00;
            border: 2px solid #ff9800;
        }
        
        .status-connected {
            background: #e3f2fd;
            color: #1976d2;
            border: 2px solid #2196F3;
        }
        
        .status-calling {
            background: #fce4ec;
            color: #c2185b;
            border: 2px solid #e91e63;
        }
        
        .info-text {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .video-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .video-box {
            flex: 1;
            text-align: center;
        }
        
        .video-box h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .video-box video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 3px solid #4CAF50;
            border-radius: 10px;
            background: #000;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        .log-info { color: #17a2b8; }
        
        .incoming-call {
            background: #fff3cd;
            border: 3px solid #ffc107;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .incoming-call h3 {
            color: #856404;
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        
        .incoming-call .caller-info {
            font-size: 18px;
            color: #856404;
            margin-bottom: 20px;
        }
        
        .incoming-call .btn {
            margin: 0 10px;
            padding: 15px 30px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <div class="header">
                <h1>üìû –°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤</h1>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à ID, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º—É –∑–≤–æ–Ω–∏—Ç—å –∏–ª–∏ –∂–¥–∏—Ç–µ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤</p>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                    <h3 style="margin-bottom: 10px;">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:</h3>
                    <p><strong>1.</strong> –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö</p>
                    <p><strong>2.</strong> –ù–∞ –ø–µ—Ä–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ: –≤—ã–±–µ—Ä–∏—Ç–µ user1, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å, –≤—ã–±–µ—Ä–∏—Ç–µ user2, –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–∑–≤–æ–Ω–∏—Ç—å"</p>
                    <p><strong>3.</strong> –ù–∞ –≤—Ç–æ—Ä–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ: –≤—ã–±–µ—Ä–∏—Ç–µ user2, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å, –¥–æ–∂–¥–∏—Ç–µ—Å—å –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞</p>
                </div>
            </div>
            
            <!-- –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="section">
                <h3>üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h3>
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à ID:</label>
                    <select id="currentUserId" class="form-control">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à ID</option>
                        <option value="user1">user1</option>
                        <option value="user2">user2</option>
                        <option value="user3">user3</option>
                        <option value="user4">user4</option>
                        <option value="user5">user5</option>
                    </select>
                </div>
                
                <button onclick="initializeUser()" id="initBtn" class="btn btn-primary">üöÄ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                <button onclick="resetCurrentUser()" id="resetBtn" class="btn btn-danger hidden">üîÑ –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
            
            <!-- –í—ã–±–æ—Ä —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è) -->
            <div id="targetUserSection" class="section hidden">
                <h3>üìû –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–≤–æ–Ω–∫–∞</h3>
                <div class="form-group">
                    <label>–ö–æ–º—É –∑–≤–æ–Ω–∏—Ç—å:</label>
                    <select id="targetUserId" class="form-control" onchange="onTargetUserChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–≤–æ–Ω–∫–∞</option>
                        <option value="user1">user1</option>
                        <option value="user2">user2</option>
                        <option value="user3">user3</option>
                        <option value="user4">user4</option>
                        <option value="user5">user5</option>
                    </select>
                </div>
                <button onclick="startCall()" id="callBtn" class="btn btn-success hidden">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
                <p class="info-text">–ò–ª–∏ –∂–¥–∏—Ç–µ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            </div>
            
            <!-- –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–π) -->
            <div id="incomingCallSection" class="section hidden incoming-call">
                <h3>üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h3>
                <div class="caller-info">
                    <p><strong>–ó–≤–æ–Ω–∏—Ç:</strong> <span id="callerId"></span></p>
                    <p>–ü—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–≤–æ–Ω–æ–∫?</p>
                </div>
                <div>
                    <button onclick="acceptCall()" id="acceptBtn" class="btn btn-success">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                    <button onclick="rejectCall()" id="rejectBtn" class="btn btn-danger">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            </div>
            
            <!-- –°—Ç–∞—Ç—É—Å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div id="userControls" class="section hidden">
                <h3>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                <div id="statusDisplay" class="status status-idle">
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="userStatus">–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫—É</span>
                </div>
                <div class="info-text">
                    <p>–í–∞—à ID: <strong id="currentUserDisplay"></strong></p>
                    <p>–¶–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong id="targetUserDisplay"></strong></p>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="disconnectCall()" id="disconnectBtn" class="btn btn-danger hidden">üîå –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
                </div>
            </div>
            
            <!-- –í–∏–¥–µ–æ -->
            <div id="videoSection" class="section hidden">
                <h3>üé• –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</h3>
                <div class="video-container">
                    <div class="video-box">
                        <h4>–í–∞—à–µ –≤–∏–¥–µ–æ</h4>
                        <video id="localVideo" autoplay muted></video>
                    </div>
                    <div class="video-box">
                        <h4>–£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ</h4>
                        <video id="remoteVideo" autoplay></video>
                    </div>
                </div>
            </div>
            
            <!-- –õ–æ–≥–∏ -->
            <div class="section">
                <h3>üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h3>
                <button onclick="copyLogs()" class="btn btn-primary" style="margin-bottom: 15px;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</button>
                <div id="log" class="log"></div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const SIGNALING_SERVER = 'https://lizamsg.ru:3000/api/signaling';
        let currentUser = null;
        let targetUser = null;
        let isResetting = false;
        let globalInitiator = null;
        let incomingCaller = null;
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è WebRTC
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                {
                    urls: 'turn:89.169.141.202:3478',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                },
                {
                    urls: 'turns:89.169.141.202:3479',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                }
            ]
        };
        
        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);
            
            const logContainer = document.getElementById('log');
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${type}`;
            logElement.textContent = logEntry;
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function initializeUser() {
            const userId = document.getElementById('currentUserId').value;
            
            if (!userId) {
                log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            currentUser = {
                id: userId,
                lastSignalId: Math.floor(Date.now() / 1000) - 60,
                state: 'idle',
                targetUser: null,
                interval: null,
                peerConnection: null,
                localStream: null,
                log: (message, type = 'info') => log(`[${userId}] ${message}`, type)
            };
            
            log(`üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`, 'success');
            log(`üìû –ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º - –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º—É –∑–≤–æ–Ω–∏—Ç—å –∏–ª–∏ –∂–¥–∏—Ç–µ –≤—Ö–æ–¥—è—â–∏—Ö`, 'info');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                currentUser.localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = currentUser.localStream;
                currentUser.log('‚úÖ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã', 'success');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º polling
                if (currentUser.interval) clearInterval(currentUser.interval);
                currentUser.interval = setInterval(() => checkSignals(), 3000);
                checkSignals();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                document.getElementById('targetUserSection').classList.remove('hidden');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateUI();
                currentUser.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º', 'success');
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
            }
        }
        
        // –°–±—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function resetCurrentUser() {
            if (isResetting) {
                log('‚ö†Ô∏è –°–±—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è', 'warning');
                return;
            }
            
            isResetting = true;
            
            if (currentUser) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling
                if (currentUser.interval) {
                    clearInterval(currentUser.interval);
                    currentUser.interval = null;
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º PeerConnection
                if (currentUser.peerConnection) {
                    currentUser.peerConnection.close();
                    currentUser.peerConnection = null;
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                if (currentUser.localStream) {
                    currentUser.localStream.getTracks().forEach(track => track.stop());
                }
                
                currentUser.log('üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–±—Ä–æ—à–µ–Ω', 'warning');
            }
            
            // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            currentUser = null;
            targetUser = null;
            globalInitiator = null;
            incomingCaller = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('targetUserSection').classList.add('hidden');
            document.getElementById('userControls').classList.add('hidden');
            document.getElementById('videoSection').classList.add('hidden');
            document.getElementById('incomingCallSection').classList.add('hidden');
            document.getElementById('initBtn').classList.remove('hidden');
            document.getElementById('resetBtn').classList.add('hidden');
            document.getElementById('callBtn').classList.add('hidden');
            
            isResetting = false;
            log('üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–µ–Ω', 'warning');
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function onTargetUserChange() {
            if (!currentUser) return;
            
            const targetId = document.getElementById('targetUserId').value;
            const callBtn = document.getElementById('callBtn');
            
            if (targetId && targetId !== currentUser.id) {
                currentUser.targetUser = targetId;
                callBtn.classList.remove('hidden');
                log(`üéØ –í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –∑–≤–æ–Ω–∫–∞: ${targetId}`, 'info');
            } else {
                currentUser.targetUser = null;
                callBtn.classList.add('hidden');
                log('üéØ –¶–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω', 'info');
            }
            
            updateUI();
        }
        
        // –°–æ–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫ (–ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
        async function startCall() {
            if (!currentUser || currentUser.state !== 'idle') {
                log('‚ùå –ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≥–æ—Ç–æ–≤', 'error');
                return;
            }
            
            const targetId = document.getElementById('targetUserId').value;
            if (!targetId) {
                log('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–≤–æ–Ω–∫–∞', 'error');
                return;
            }
            
            if (currentUser.id === targetId) {
                log('‚ùå –ù–µ–ª—å–∑—è –∑–≤–æ–Ω–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ', 'error');
                return;
            }
            
            targetUser = targetId;
            currentUser.targetUser = targetId;
            
            currentUser.log(`üìû –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—ã–π –≤—ã–∑–æ–≤ –∫ ${targetId}`, 'info');
            
            try {
                // –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping
                currentUser.log(`üì§ –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –∫ ${targetId}`, 'info');
                await sendPing();
                
                // –ñ–¥–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ping-pong —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                currentUser.log(`‚è≥ –û–∂–∏–¥–∞–µ–º pong –æ—Ç ${targetId}...`, 'info');
                currentUser.log(`üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ${targetId} –∑–∞–ø—É—â–µ–Ω –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ`, 'info');
                await waitForState('connected', 30000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 30 —Å–µ–∫—É–Ω–¥
                
                // –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
                currentUser.log(`üì§ –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer –∫ ${targetId}`, 'info');
                await sendOffer();
                
                // –ñ–¥–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è answer
                currentUser.log(`‚è≥ –û–∂–∏–¥–∞–µ–º answer –æ—Ç ${targetId}...`, 'info');
                await waitForAnswer(10000);
                
                // –®–∞–≥ 3: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º P2P
                currentUser.log(`üì§ –®–∞–≥ 3: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ`, 'info');
                await startP2PCall();
                
                log('‚úÖ –ó–≤–æ–Ω–æ–∫ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!', 'success');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ: ${error.message}`, 'error');
                resetCurrentUser();
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ ping
        async function sendPing() {
            if (currentUser.state !== 'idle') {
                currentUser.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ping - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }
            
            currentUser.state = 'connecting';
            currentUser.targetUser = targetUser;
            globalInitiator = currentUser.id;
            currentUser.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${currentUser.state}`, 'info');
            currentUser.log(`üîç –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω globalInitiator: ${globalInitiator}`, 'info');
            currentUser.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ping –∫ ${targetUser}`, 'warning');
            
            try {
                const pingData = {
                    action: 'ping',
                    from: currentUser.id,
                    to: targetUser,
                    data: { timestamp: Date.now() }
                };
                currentUser.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(pingData)}`, 'info');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pingData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                currentUser.log(`üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    currentUser.log(`‚úÖ Ping –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è pong
                    setTimeout(() => checkSignals(), 100);
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping');
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    currentUser.log(`‚ùå –¢–∞–π–º–∞—É—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ ping`, 'error');
                } else {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping: ${error.message}`, 'error');
                }
                throw error;
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ offer
        async function sendOffer() {
            if (currentUser.state !== 'connected') {
                currentUser.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å offer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }
            
            currentUser.log('üîß –°–æ–∑–¥–∞–Ω–∏–µ Peer Connection...', 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º Peer Connection
                currentUser.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                currentUser.localStream.getTracks().forEach(track => {
                    currentUser.peerConnection.addTrack(track, currentUser.localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                currentUser.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        currentUser.log('üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞–π–¥–µ–Ω', 'info');
                        sendSignal('ice-candidate', event.candidate);
                    }
                };
                
                currentUser.peerConnection.ontrack = (event) => {
                    currentUser.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                currentUser.peerConnection.onconnectionstatechange = () => {
                    currentUser.log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${currentUser.peerConnection.connectionState}`, 'info');
                    if (currentUser.peerConnection.connectionState === 'connected') {
                        currentUser.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                    } else if (currentUser.peerConnection.connectionState === 'failed') {
                        currentUser.log('‚ùå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å', 'error');
                    } else if (currentUser.peerConnection.connectionState === 'disconnected') {
                        currentUser.log('üîå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'warning');
                        if (!isResetting) {
                            isResetting = true;
                            currentUser.log('üîÑ –°–±—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —Ä–∞–∑—Ä—ã–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'warning');
                            resetCurrentUser();
                            setTimeout(() => {
                                initializeUser();
                            }, 1000);
                            isResetting = false;
                        }
                    }
                };
                
                // –°–æ–∑–¥–∞–µ–º offer
                const offer = await currentUser.peerConnection.createOffer();
                await currentUser.peerConnection.setLocalDescription(offer);
                currentUser.log('üì§ Offer —Å–æ–∑–¥–∞–Ω', 'success');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
                await sendSignal('offer', offer);
                currentUser.log('üì§ Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
                currentUser.state = 'calling';
                updateUI();
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function startP2PCall() {
            if (currentUser.state !== 'calling') {
                currentUser.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å P2P - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }
            
            currentUser.log('üîó –ê–∫—Ç–∏–≤–∞—Ü–∏—è P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...', 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ —Ç—Ä–µ–∫–∏
            if (currentUser.localStream && currentUser.peerConnection.getSenders().length === 0) {
                currentUser.localStream.getTracks().forEach(track => {
                    currentUser.peerConnection.addTrack(track, currentUser.localStream);
                });
                currentUser.log('üì§ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ PeerConnection', 'info');
            } else {
                currentUser.log('üì§ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ PeerConnection', 'info');
            }
            
            currentUser.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ', 'success');
            updateUI();
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞
        async function sendSignal(type, data) {
            const signalData = {
                action: 'signal',
                from: currentUser.id,
                to: targetUser,
                type: type,
                data: data
            };
            
            try {
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(signalData)
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser.log(`‚úÖ –°–∏–≥–Ω–∞–ª ${type} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`, 'success');
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞');
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ ${type}: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
        async function checkSignals() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${SIGNALING_SERVER}?from=${currentUser.id}&lastId=${currentUser.lastSignalId}`);
                const result = await response.json();
                
                if (result.success && result.signals.length > 0) {
                    currentUser.log(`üì® –ü–æ–ª—É—á–µ–Ω–æ ${result.signals.length} —Å–∏–≥–Ω–∞–ª–æ–≤`, 'info');
                    
                    for (const signal of result.signals) {
                        currentUser.lastSignalId = Math.max(currentUser.lastSignalId, signal.id);
                        await handleSignal(signal);
                    }
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤: ${error.message}`, 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–∞
        async function handleSignal(signal) {
            currentUser.log(`üì® –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª: ${signal.type} –æ—Ç ${signal.from}`, 'info');
            
            switch (signal.type) {
                case 'incoming-call':
                    if (currentUser.state === 'idle') {
                        incomingCaller = signal.from;
                        currentUser.log(`üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${incomingCaller}`, 'info');
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
                        document.getElementById('callerId').textContent = incomingCaller;
                        document.getElementById('incomingCallSection').classList.remove('hidden');
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–≤–æ–Ω–∫–∞
                        document.getElementById('callBtn').classList.add('hidden');
                        
                        currentUser.log(`‚úÖ UI –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ –ø–æ–∫–∞–∑–∞–Ω`, 'success');
                    } else {
                        currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                    }
                    break;
                    
                case 'call-accepted':
                    if (currentUser.state === 'idle' && signal.from === targetUser) {
                        currentUser.log(`‚úÖ ${signal.from} –ø—Ä–∏–Ω—è–ª –∑–≤–æ–Ω–æ–∫`, 'success');
                        currentUser.state = 'calling';
                        updateUI();
                    }
                    break;
                    
                case 'call-rejected':
                    if (currentUser.state === 'idle' && signal.from === targetUser) {
                        currentUser.log(`‚ùå ${signal.from} –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–≤–æ–Ω–æ–∫`, 'warning');
                        resetCurrentUser();
                    }
                    break;
                    
                case 'pong':
                    if (currentUser.state === 'connecting') {
                        currentUser.state = 'connected';
                        currentUser.log('üèì –ü–æ–ª—É—á–µ–Ω pong - —Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                        updateUI();
                    }
                    break;
                    
                case 'offer':
                    if (currentUser.state === 'connected' || currentUser.state === 'calling') {
                        await handleOffer(signal);
                    }
                    break;
                    
                case 'answer':
                    if (currentUser.state === 'calling') {
                        await handleAnswer(signal);
                    }
                    break;
                    
                case 'ice-candidate':
                    if (currentUser.peerConnection) {
                        await currentUser.peerConnection.addIceCandidate(signal.data);
                        currentUser.log('üßä ICE candidate –¥–æ–±–∞–≤–ª–µ–Ω', 'info');
                    }
                    break;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ offer
        async function handleOffer(signal) {
            currentUser.log('üì• –ü–æ–ª—É—á–µ–Ω offer', 'info');
            
            if (!currentUser.peerConnection) {
                currentUser.peerConnection = new RTCPeerConnection(rtcConfig);
                
                currentUser.peerConnection.ontrack = (event) => {
                    currentUser.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                currentUser.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        currentUser.log('üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞–π–¥–µ–Ω', 'info');
                        sendSignal('ice-candidate', event.candidate);
                    }
                };
                
                currentUser.peerConnection.onconnectionstatechange = () => {
                    currentUser.log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${currentUser.peerConnection.connectionState}`, 'info');
                    if (currentUser.peerConnection.connectionState === 'connected') {
                        currentUser.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                    } else if (currentUser.peerConnection.connectionState === 'failed') {
                        currentUser.log('‚ùå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å', 'error');
                    } else if (currentUser.peerConnection.connectionState === 'disconnected') {
                        currentUser.log('üîå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'warning');
                        if (!isResetting) {
                            isResetting = true;
                            currentUser.log('üîÑ –°–±—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —Ä–∞–∑—Ä—ã–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'warning');
                            resetCurrentUser();
                            setTimeout(() => {
                                initializeUser();
                            }, 1000);
                            isResetting = false;
                        }
                    }
                };
            }
            
            await currentUser.peerConnection.setRemoteDescription(signal.data);
            currentUser.log('‚úÖ Offer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
            
            const answer = await currentUser.peerConnection.createAnswer();
            await currentUser.peerConnection.setLocalDescription(answer);
            currentUser.log('üì§ Answer —Å–æ–∑–¥–∞–Ω', 'success');
            
            await sendSignal('answer', answer);
            currentUser.log('üì§ Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            
            currentUser.state = 'calling';
            updateUI();
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ answer
        async function handleAnswer(signal) {
            currentUser.log('üì• –ü–æ–ª—É—á–µ–Ω answer', 'info');
            await currentUser.peerConnection.setRemoteDescription(signal.data);
            currentUser.log('‚úÖ Answer —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
        }
        
        // –ü—Ä–∏–Ω—è—Ç–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        async function acceptCall() {
            if (!incomingCaller) {
                log('‚ùå –ù–µ—Ç –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è', 'error');
                return;
            }
            
            currentUser.log(`‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ–º –∑–≤–æ–Ω–æ–∫ –æ—Ç ${incomingCaller}`, 'success');
            
            // –°–∫—Ä—ã–≤–∞–µ–º UI –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            document.getElementById('incomingCallSection').classList.add('hidden');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            currentUser.state = 'calling';
            currentUser.targetUser = incomingCaller;
            globalInitiator = incomingCaller;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–≤–æ–Ω–∫–∞
            const acceptData = {
                action: 'signal',
                from: currentUser.id,
                to: incomingCaller,
                type: 'call-accepted',
                data: { timestamp: Date.now() }
            };
            
            try {
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(acceptData)
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser.log('‚úÖ –°–∏–≥–Ω–∞–ª –ø—Ä–∏–Ω—è—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–Ω—è—Ç–∏—è: ${error.message}`, 'error');
            }
            
            // –û—á–∏—â–∞–µ–º –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
            incomingCaller = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
        }
        
        // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        async function rejectCall() {
            if (!incomingCaller) {
                log('‚ùå –ù–µ—Ç –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            currentUser.log(`‚ùå –û—Ç–∫–ª–æ–Ω—è–µ–º –∑–≤–æ–Ω–æ–∫ –æ—Ç ${incomingCaller}`, 'warning');
            
            // –°–∫—Ä—ã–≤–∞–µ–º UI –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            document.getElementById('incomingCallSection').classList.add('hidden');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞
            const rejectData = {
                action: 'signal',
                from: currentUser.id,
                to: incomingCaller,
                type: 'call-rejected',
                data: { timestamp: Date.now() }
            };
            
            try {
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rejectData)
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser.log('‚úÖ –°–∏–≥–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            }
            
            // –û—á–∏—â–∞–µ–º –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
            incomingCaller = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        async function disconnectCall() {
            if (isResetting) {
                log('‚ö†Ô∏è –°–±—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è', 'warning');
                return;
            }
            
            isResetting = true;
            
            if (currentUser && currentUser.peerConnection) {
                currentUser.log('üîå –ó–∞–∫—Ä—ã–≤–∞–µ–º P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'info');
                currentUser.peerConnection.close();
                currentUser.peerConnection = null;
            }
            
            // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ
            document.getElementById('remoteVideo').srcObject = null;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            currentUser.state = 'idle';
            globalInitiator = null;
            incomingCaller = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
            
            isResetting = false;
            log('üîÑ –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'warning');
        }
        
        // –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function waitForState(targetState, timeoutMs = 10000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                let lastLogTime = 0;
                
                const checkState = () => {
                    const elapsed = Date.now() - startTime;
                    const remaining = Math.max(0, timeoutMs - elapsed);
                    
                    // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
                    if (elapsed - lastLogTime >= 5000) {
                        currentUser.log(`‚è≥ –û–∂–∏–¥–∞–µ–º ${targetState}... –æ—Å—Ç–∞–ª–æ—Å—å ${Math.round(remaining/1000)}—Å`, 'info');
                        lastLogTime = elapsed;
                    }
                    
                    if (currentUser.state === targetState) {
                        currentUser.log(`‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ ${targetState} –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –∑–∞ ${Math.round(elapsed/1000)}—Å`, 'success');
                        resolve();
                    } else if (elapsed > timeoutMs) {
                        currentUser.log(`‚ùå –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ${targetState} (${Math.round(timeoutMs/1000)}—Å)`, 'error');
                        currentUser.log(`üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:`, 'info');
                        currentUser.log(`   - –¶–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ø—É—â–µ–Ω`, 'info');
                        currentUser.log(`   - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é`, 'info');
                        currentUser.log(`   - –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç`, 'info');
                        reject(new Error(`–¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ${targetState}`));
                    } else {
                        setTimeout(checkState, 100);
                    }
                };
                
                checkState();
            });
        }
        
        // –û–∂–∏–¥–∞–Ω–∏–µ answer
        function waitForAnswer(timeoutMs = 10000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                const checkAnswer = () => {
                    if (currentUser.peerConnection && currentUser.peerConnection.remoteDescription) {
                        resolve();
                    } else if (Date.now() - startTime > timeoutMs) {
                        reject(new Error('–¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è answer'));
                    } else {
                        setTimeout(checkAnswer, 100);
                    }
                };
                
                checkAnswer();
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI() {
            if (!currentUser) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('currentUserDisplay').textContent = currentUser.id;
            document.getElementById('targetUserDisplay').textContent = currentUser.targetUser || '–ù–µ –≤—ã–±—Ä–∞–Ω';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            const statusElement = document.getElementById('userStatus');
            const statusDisplay = document.getElementById('statusDisplay');
            
            switch (currentUser.state) {
                case 'idle':
                    statusElement.textContent = '–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫—É';
                    statusDisplay.className = 'status status-idle';
                    break;
                case 'connecting':
                    statusElement.textContent = '–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤—è–∑—å...';
                    statusDisplay.className = 'status status-connecting';
                    break;
                case 'connected':
                    statusElement.textContent = '–°–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
                    statusDisplay.className = 'status status-connected';
                    break;
                case 'calling':
                    statusElement.textContent = '–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
                    statusDisplay.className = 'status status-calling';
                    break;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
            const callBtn = document.getElementById('callBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const incomingCallSection = document.getElementById('incomingCallSection');
            
            if (currentUser.state === 'idle' && !incomingCaller) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–≤–æ–Ω–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                if (currentUser.targetUser) {
                    callBtn.classList.remove('hidden');
                } else {
                    callBtn.classList.add('hidden');
                }
                disconnectBtn.classList.add('hidden');
                incomingCallSection.classList.add('hidden');
            } else if (currentUser.state === 'calling') {
                callBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                incomingCallSection.classList.add('hidden');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (currentUser.state === 'calling') {
                document.getElementById('videoSection').classList.remove('hidden');
            } else {
                document.getElementById('videoSection').classList.add('hidden');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (currentUser) {
                document.getElementById('userControls').classList.remove('hidden');
            }
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤
        function copyLogs() {
            const logContainer = document.getElementById('log');
            const logText = logContainer.textContent;
            
            navigator.clipboard.writeText(logText).then(() => {
                log('üìã –õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            }).catch(err => {
                log('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–æ–≤: ' + err.message, 'error');
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üöÄ –°–∏—Å—Ç–µ–º–∞ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            log('üìã –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à ID –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–≤–æ–Ω–∫–∞', 'info');
        });
    </script>
</body>
</html>