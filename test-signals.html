<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
        .info { background: #d1ecf1; }
    </style>
</head>
<body>
    <h1>üì° –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤</h1>
    
    <div>
        <label>User ID: <input type="text" id="userId" value="user12" style="width: 100px;"></label>
        <button onclick="startPolling()">–ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</button>
        <button onclick="stopPolling()">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        const SIGNALING_SERVER = 'https://functions.yandexcloud.net/d4ec0rusp5blvc9pucd4';
        let pollingInterval = null;
        let lastSignalId = 0;
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        async function checkSignals() {
            const userId = document.getElementById('userId').value;
            
            try {
                const url = `${SIGNALING_SERVER}?action=signals&userId=${userId}&since=${lastSignalId}`;
                addResult(`üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è ${userId}...`, 'info');
                
                const response = await fetch(url);
                const data = await response.json();
                
                addResult(`üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(data)}`, 'info');
                
                if (data.success && data.signals && data.signals.length > 0) {
                    addResult(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${data.signals.length} —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
                    
                    data.signals.forEach(signal => {
                        addResult(`üì® –°–∏–≥–Ω–∞–ª: ${signal.type} –æ—Ç ${signal.from} –∫ ${signal.to}`, 'success');
                        lastSignalId = Math.max(lastSignalId, signal.id);
                    });
                } else {
                    addResult(`‚ÑπÔ∏è –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤`, 'info');
                }
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        function startPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            addResult('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤...', 'success');
            pollingInterval = setInterval(checkSignals, 2000);
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                addResult('‚èπÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'warning');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
        window.addEventListener('load', () => {
            addResult('üìã –¢–µ—Å—Ç –≥–æ—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É"', 'info');
        });
    </script>
</body>
</html>
