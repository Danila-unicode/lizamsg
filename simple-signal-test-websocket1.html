<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ - LizaApp</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .user-section { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 8px; background: #fafafa; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .status.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.connecting { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –¥—Ä—É–∑–µ–π */
        .friends-section { margin: 20px 0; }
        .search-section { margin: 15px 0; }
        .search-results { margin: 10px 0; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px; background: #f9f9f9; }
        .user-item .username { font-weight: bold; }
        .user-item .actions { display: flex; gap: 5px; }
        .friends-list, .requests-list, .sent-requests-list { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0; background: #fafafa; }
        .friend-item, .request-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid #eee; margin: 3px 0; border-radius: 3px; background: white; }
        .friend-item .username, .request-item .username { font-weight: bold; }
        .friend-item .actions, .request-item .actions { display: flex; gap: 5px; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        
        /* –°–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .old-functionality { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ LizaApp</h1>
        <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –í–æ–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º –ª–æ–≥–∏–Ω–æ–º –∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –í—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å —ç—Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>
        <button onclick="window.open('https://lizaapp.wg01.ru/register.php', '_blank')" style="background: #4CAF50; color: white; padding: 10px 20px; margin: 10px 0; border: none; border-radius: 5px; cursor: pointer;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        
        <div class="user-section">
            <h2>üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="loginSection">
                <input type="text" id="userId" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω">
                <input type="password" id="userPassword" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display: none;">
                <button onclick="showPasswordField(event)">–í–æ–π—Ç–∏</button>
        </div>
            
            <div id="userInfo" style="display: none;">
                <div id="userStatus" class="status disconnected">–û—Ç–∫–ª—é—á–µ–Ω</div>
                <p><strong>–õ–æ–≥–∏–Ω:</strong> <span id="currentUserId"></span></p>
                <input type="text" id="targetUserId" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞" class="old-functionality">
                <button onclick="startCall()" id="startCallBtn" disabled style="background: #4CAF50; color: white; display: none;" class="old-functionality">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
                <button onclick="disconnectCall()" id="disconnectBtn" disabled style="background: #f44336; color: white; display: none;" class="old-functionality">üîå –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                <button onclick="resetUser()" style="background: #ff9800; color: white; display: none;">üîÑ –í—ã–π—Ç–∏</button>
                </div>
        
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <video id="localVideo" autoplay muted style="width: 200px; height: 150px; border: 2px solid #4CAF50; background: #000; border-radius: 5px;"></video>
                <video id="remoteVideo" autoplay style="width: 200px; height: 150px; border: 2px solid #2196F3; background: #000; border-radius: 5px;"></video>
                </div>
            
            <div id="log" class="log"></div>
        </div>
            
        <!-- –û–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ -->
        <div id="incomingCallModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <h2 style="color: #333; margin-bottom: 20px;">üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</h2>
                <p style="font-size: 18px; margin-bottom: 30px;">–í–∞–º –∑–≤–æ–Ω–∏—Ç: <strong id="callerName"></strong></p>
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <button onclick="acceptIncomingCall()" style="background: #4CAF50; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                    <button onclick="rejectIncomingCall()" style="background: #f44336; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
        <div id="chatModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1001; justify-content: center; align-items: center;">
            <div style="background: white; width: 400px; height: 500px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
                <div style="background: #2196F3; color: white; padding: 15px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">üí¨ –ß–∞—Ç —Å <span id="chatFriendName"></span></h3>
                    <button onclick="closeChat()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
                </div>
                
                <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
                <div id="chatMessages" style="flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9;">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
                
                <!-- –ü–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏ -->
                <div id="emojiPanel" style="display: none; padding: 10px; background: #e3f2fd; border-top: 1px solid #ddd;">
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <span onclick="sendEmoji('üòÄ')" style="cursor: pointer; font-size: 20px;">üòÄ</span>
                        <span onclick="sendEmoji('üòÇ')" style="cursor: pointer; font-size: 20px;">üòÇ</span>
                        <span onclick="sendEmoji('üòç')" style="cursor: pointer; font-size: 20px;">üòç</span>
                        <span onclick="sendEmoji('ü§î')" style="cursor: pointer; font-size: 20px;">ü§î</span>
                        <span onclick="sendEmoji('üëç')" style="cursor: pointer; font-size: 20px;">üëç</span>
                        <span onclick="sendEmoji('üëé')" style="cursor: pointer; font-size: 20px;">üëé</span>
                        <span onclick="sendEmoji('‚ù§Ô∏è')" style="cursor: pointer; font-size: 20px;">‚ù§Ô∏è</span>
                        <span onclick="sendEmoji('üéâ')" style="cursor: pointer; font-size: 20px;">üéâ</span>
                    </div>
                </div>
                
                <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
                <div style="padding: 15px; border-top: 1px solid #ddd; background: white; border-radius: 0 0 15px 15px;">
                    <div style="display: flex; gap: 10px;">
                        <button onclick="toggleEmojiPanel()" style="background: #ff9800; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">üòÄ</button>
                        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onkeypress="handleMessageKeyPress(event)">
                        <button onclick="sendMessage()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
            
        <!-- –°–∏—Å—Ç–µ–º–∞ –¥—Ä—É–∑–µ–π -->
        <div class="user-section" id="friendsSection" style="display: none;">
            <h2>üë• –°–∏—Å—Ç–µ–º–∞ –¥—Ä—É–∑–µ–π</h2>
            
            <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="search-section">
                <h3>üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                <input type="text" id="searchUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="width: 300px;">
                <button onclick="searchUser()" class="btn-primary">üîç –ù–∞–π—Ç–∏</button>
                <div id="searchResults" class="search-results"></div>
        </div>
            
            <!-- –°–ø–∏—Å–∫–∏ -->
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- –î—Ä—É–∑—å—è -->
                <div style="flex: 1; min-width: 250px;">
                    <h3>üë• –î—Ä—É–∑—å—è</h3>
                    <div id="friendsList" class="friends-list">
                        <p style="color: #666; text-align: center; margin: 20px 0;">–ù–µ—Ç –¥—Ä—É–∑–µ–π</p>
                </div>
        </div>
            
                <!-- –ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è -->
                <div style="flex: 1; min-width: 250px;">
                    <h3>üì® –ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è</h3>
                    <div id="requestsList" class="requests-list">
                        <p style="color: #666; text-align: center; margin: 20px 0;">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤</p>
        </div>
            </div>
            
                <!-- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
                <div style="flex: 1; min-width: 250px;">
                    <h3>üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h3>
                    <div id="sentRequestsList" class="sent-requests-list">
                        <p style="color: #666; text-align: center; margin: 20px 0;">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</p>
                </div>
        </div>
        </div>
        </div>
        
        <div class="user-section">
            <h2>üìã –õ–æ–≥–∏</h2>
            <button onclick="copyLogs()" style="background: #4CAF50; color: white; font-weight: bold;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏</button>
            <p>–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å–∫–æ–ø–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É</p>
        </div>
    </div>

    <script>
        console.log('Script started');
        // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤)
        const WEBSOCKET_URL = 'wss://lizamsg.ru:9000';
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —á–∞—Ç–æ–≤
        const CHAT_WEBSOCKET_URL = 'wss://lizacom.ru:9002';
        
        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { 
                    urls: 'turn:89.169.141.202:3478',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                },
                { 
                    urls: 'turns:62.84.126.200:3479',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                }
            ]
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = {
            id: null,
            ws: null,
            state: 'idle', // idle, connecting, connected, calling
            targetUser: null,
            peerConnection: null,
            localStream: null,
            sessionToken: null,
            isInitiator: false,
            webrtcInitiated: false,
            wsConnected: false,
            wsUserId: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤
        function connectCallsWebSocket() {
            return new Promise((resolve, reject) => {
                try {
                    const wsUrl = `${WEBSOCKET_URL}?username=${encodeURIComponent(currentUser.id)}`;
                    currentUser.callsWs = new WebSocket(wsUrl);
                    
                    currentUser.callsWs.onopen = () => {
                        currentUser.callsWsConnected = true;
                        currentUser.log('üîå WebSocket –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                        resolve();
                    };
                    
                    currentUser.callsWs.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            handleCallsWebSocketMessage(message);
                        } catch (error) {
                            currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤: ${error.message}`, 'error');
                        }
                    };
                    
                    currentUser.callsWs.onclose = () => {
                        currentUser.callsWsConnected = false;
                        currentUser.log('üîå WebSocket –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω', 'warning');
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                        if (currentUser.id) {
                            setTimeout(() => {
                                if (currentUser.id && !currentUser.callsWsConnected) {
                                    currentUser.log('üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –∑–≤–æ–Ω–∫–æ–≤...', 'info');
                                    connectCallsWebSocket().catch(error => {
                                        currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤: ${error.message}`, 'error');
                                    });
                                }
                            }, 3000);
                        }
                    };
                    
                    currentUser.callsWs.onerror = (error) => {
                        currentUser.log(`‚ùå –û—à–∏–±–∫–∞ WebSocket –∑–≤–æ–Ω–∫–æ–≤: ${error.message}`, 'error');
                        reject(error);
                    };
                
            } catch (error) {
                    reject(error);
                }
            });
        }
        
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤
        function handleCallsWebSocketMessage(message) {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (message.type === 'connected') {
                currentUser.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ`, 'success');
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º userId –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π
                if (message.userId) {
                    currentUser.wsUserId = message.userId;
                    currentUser.log(`üÜî WebSocket ID: ${message.userId}`, 'info');
                }
                return;
            }
            
            if (message.type === 'error') {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${message.message}`, 'error');
                return;
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã
            if (message.from) {
                currentUser.log(`üì® –ü–æ–ª—É—á–µ–Ω–æ: ${message.type} –æ—Ç ${message.from}`, 'info');
            }
            
            switch (message.type) {
                case 'ping':
                    handlePing(message);
                    break;
                case 'pong':
                    handlePong(message);
                    break;
                case 'offer':
                    handleOffer(message);
                    break;
                case 'answer':
                    handleAnswer(message);
                    break;
                case 'ice-candidate':
                    handleIceCandidate(message);
                    break;
                case 'disconnect':
                    handleDisconnect(message);
                    break;
                case 'chat_message':
                    handleChatMessage(message);
                    break;
                default:
                    if (message.from) {
                        currentUser.log(`‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: ${message.type}`, 'warning');
                    }
            }
        }
        
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤
        function sendCallsWebSocketMessage(type, data, to = null) {
            if (!currentUser.callsWsConnected || !currentUser.callsWs) {
                currentUser.log('‚ùå WebSocket –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                return;
            }
            
            const message = {
                type: type,
                from: currentUser.wsUserId || currentUser.id,
                to: to || currentUser.targetUser,
                data: data,
                timestamp: Date.now()
            };
            
            try {
                currentUser.callsWs.send(JSON.stringify(message));
                currentUser.log(`‚úÖ ${type} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`, 'success');
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ${type}: ${error.message}`, 'error');
            }
        }
        
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è
        function showPasswordField(event) {
            const passwordField = document.getElementById('userPassword');
            const loginButton = event.target;
            
            if (passwordField.style.display === 'none') {
                passwordField.style.display = 'block';
                loginButton.textContent = '–í–æ–π—Ç–∏';
                loginButton.onclick = () => startUser();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function startUser() {
            const username = document.getElementById('userId').value;
            const password = document.getElementById('userPassword').value;
            
            if (!username) {
                currentUser.log(`‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω`, 'error');
                return;
            }
            
            if (!password) {
                currentUser.log(`‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å`, 'error');
                return;
            }
            
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUser.log(`üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}...`, 'info');
            
            try {
                const response = await fetch('https://lizaapp.wg01.ru/api/login.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser.id = username;
                    currentUser.sessionToken = data.sessionToken;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
                    localStorage.setItem('userData', JSON.stringify({
                        username: username,
                        userId: data.userId,
                        sessionToken: data.sessionToken
                    }));
                    
                    currentUser.log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞`, 'success');
                } else {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${data.error}`, 'error');
                    return;
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º`, 'error');
                return;
            }
            
            currentUser.lastSignalId = Math.floor(Date.now() / 1000) - 60; // –ü–æ–ª—É—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
            currentUser.state = 'idle';
            currentUser.targetUser = null;
            currentUser.isInitiator = false;
            currentUser.webrtcInitiated = false;
            currentUser.log(`üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${currentUser.id} –≥–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º`, 'success');
            currentUser.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—à–µ: ${currentUser.lastSignalId}`, 'info');
            currentUser.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'info');
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä–∞–º
            try {
                await connectCallsWebSocket();
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket: ${error.message}`, 'error');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É –¥—Ä—É–∑–µ–π
            showFriendsSection();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ localStorage
            loadChatMessagesFromStorage();
            
            currentUser.log(`üìπ –ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –±—É–¥—É—Ç –∑–∞–ø—É—â–µ–Ω—ã –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ`, 'info');
        }
        
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
        function updateUI() {
            const loginSection = document.getElementById('loginSection');
            const userInfo = document.getElementById('userInfo');
            const userStatus = document.getElementById('userStatus');
            const currentUserId = document.getElementById('currentUserId');
            const startCallBtn = document.getElementById('startCallBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const resetBtn = document.querySelector('button[onclick="resetUser()"]');
            
            if (currentUser.id) {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                loginSection.style.display = 'none';
                userInfo.style.display = 'block';
                currentUserId.textContent = currentUser.id;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                userStatus.textContent = getStatusText();
                userStatus.className = `status ${currentUser.state}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                if (currentUser.state === 'idle') {
                startCallBtn.style.display = 'inline-block';
                startCallBtn.disabled = false;
                disconnectBtn.style.display = 'none';
                    resetBtn.style.display = 'inline-block';
                } else if (currentUser.state === 'connecting' || currentUser.state === 'connected' || currentUser.state === 'calling') {
                    startCallBtn.style.display = 'none';
                    disconnectBtn.style.display = 'inline-block';
                    disconnectBtn.disabled = false;
                    resetBtn.style.display = 'inline-block';
                }
                } else {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                loginSection.style.display = 'block';
                userInfo.style.display = 'none';
            }
        }
        
        function getStatusText() {
            switch (currentUser.state) {
                case 'idle': return '–ì–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º';
                case 'connecting': return '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                case 'connected': return '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                case 'calling': return '–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
                default: return '–û—Ç–∫–ª—é—á–µ–Ω';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞
        async function startAudioCall() {
            const targetId = document.getElementById('targetUserId').value;
            
            if (!targetId) {
                currentUser.log('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'error');
                return;
            }
            
            if (currentUser.state !== 'idle') {
                currentUser.log(`‚ùå –ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –≤—ã–∑–æ–≤ - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'error');
                return;
            }
            
            currentUser.log(`üéµ –ù–∞—á–∏–Ω–∞–µ–º –∞—É–¥–∏–æ –∑–≤–æ–Ω–æ–∫ –∫ ${targetId}`, 'info');
            currentUser.state = 'connecting';
            currentUser.targetUser = targetId;
            currentUser.isInitiator = true;
            currentUser.webrtcInitiated = false;
            updateUI();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping —á–µ—Ä–µ–∑ WebSocket —Å —Ç–∏–ø–æ–º –∞—É–¥–∏–æ
            currentUser.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –∫ ${targetId}`, 'info');
            sendCallsWebSocketMessage('ping', { timestamp: Date.now(), callType: 'audio' }, targetId);
        }
        
        async function startCall() {
            const targetId = document.getElementById('targetUserId').value;
            
            if (!targetId) {
                currentUser.log('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'error');
                return;
            }
            
            if (currentUser.state !== 'idle') {
                currentUser.log(`‚ùå –ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –≤—ã–∑–æ–≤ - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'error');
                return;
            }
            
            currentUser.log(`üìû –ù–∞—á–∏–Ω–∞–µ–º –∑–≤–æ–Ω–æ–∫ –∫ ${targetId}`, 'info');
            currentUser.state = 'connecting';
            currentUser.targetUser = targetId;
            currentUser.isInitiator = true;
            currentUser.webrtcInitiated = false;
            updateUI();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping —á–µ—Ä–µ–∑ WebSocket
            currentUser.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –∫ ${targetId}`, 'info');
            sendCallsWebSocketMessage('ping', { timestamp: Date.now(), callType: 'video' }, targetId);
        }
        
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ping
        async function handlePing(signal) {
            if (currentUser.state !== 'idle') {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ping –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }
                
            currentUser.log(`üèì –ü–æ–ª—É—á–µ–Ω ping –æ—Ç ${signal.from}`, 'info');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            incomingCall.isActive = true;
            incomingCall.caller = signal.from;
            incomingCall.offer = null; // offer –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω
            incomingCall.iceCandidates = [];
            
            document.getElementById('callerName').textContent = signal.from;
            document.getElementById('incomingCallModal').style.display = 'flex';
            
            currentUser.log(`üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${signal.from}`, 'info');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–≤–æ–Ω–∫–∞
            const callType = signal.data.callType || 'video';
            const isAudioCall = callType === 'audio';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–≤–æ–Ω–∫–∞
            try {
                if (isAudioCall) {
                    currentUser.log(`üéµ –ó–∞–ø—É—Å–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –¥–ª—è –∞—É–¥–∏–æ –∑–≤–æ–Ω–∫–∞...`, 'info');
                    currentUser.localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: false,  // –¢–æ–ª—å–∫–æ –∞—É–¥–∏–æ!
                        audio: true 
                    });
                } else {
                    currentUser.log(`üìπ –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –¥–ª—è –≤–∏–¥–µ–æ –∑–≤–æ–Ω–∫–∞...`, 'info');
                    currentUser.localStream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                }
                
                document.getElementById('localVideo').srcObject = currentUser.localStream;
                currentUser.log(`‚úÖ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã: ${currentUser.localStream.getTracks().length} —Ç—Ä–µ–∫–æ–≤`, 'success');
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ —Ç—Ä–µ–∫–æ–≤
                currentUser.localStream.getTracks().forEach(track => {
                    currentUser.log(`üìπ –¢—Ä–µ–∫: ${track.kind}, enabled: ${track.enabled}, readyState: ${track.readyState}`, 'info');
                });
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
                // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                hideIncomingCallModal();
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ pong
        function handlePong(signal) {
            if (currentUser.state === 'connecting' && currentUser.targetUser === signal.from) {
                currentUser.log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} - —Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!`, 'success');
                currentUser.state = 'connected';
                updateUI();
                
                // –¢–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä –∑–≤–æ–Ω–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç offer –ø–æ—Å–ª–µ pong
                if (currentUser.isInitiator) {
                    initiateWebRTC();
                }
                    } else {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º pong –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞—Ü–∏—è WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function initiateWebRTC() {
            if (currentUser.state !== 'connected' || currentUser.webrtcInitiated) {
                currentUser.log(`‚ö†Ô∏è –ù–µ –º–æ–∂–µ–º –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å WebRTC - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}, initiated: ${currentUser.webrtcInitiated}`, 'warning');
                return;
            }
            
            currentUser.webrtcInitiated = true;
            currentUser.log(`üé• –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ`, 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                currentUser.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                if (currentUser.localStream) {
                    currentUser.localStream.getTracks().forEach(track => {
                        currentUser.peerConnection.addTrack(track, currentUser.localStream);
                        currentUser.log(`üìπ –î–æ–±–∞–≤–ª–µ–Ω —Ç—Ä–µ–∫: ${track.kind}`, 'info');
                    });
                    currentUser.log(`üìπ –î–æ–±–∞–≤–ª–µ–Ω–æ ${currentUser.localStream.getTracks().length} —Ç—Ä–µ–∫–æ–≤ –≤ PeerConnection`, 'success');
                } else {
                    currentUser.log(`‚ùå –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ PeerConnection`, 'error');
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                currentUser.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        sendSignal('ice-candidate', event.candidate);
                    }
                };
                
                currentUser.peerConnection.ontrack = (event) => {
                    currentUser.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    currentUser.log(`üìπ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤: ${event.streams.length}`, 'info');
                    currentUser.log(`üìπ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤: ${event.track.kind}`, 'info');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                currentUser.peerConnection.onconnectionstatechange = () => {
                    currentUser.log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${currentUser.peerConnection.connectionState}`, 'info');
                    if (currentUser.peerConnection.connectionState === 'connected') {
                        currentUser.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                        currentUser.state = 'calling';
                        updateUI();
                    }
                };
                
                // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
                const offer = await currentUser.peerConnection.createOffer();
                await currentUser.peerConnection.setLocalDescription(offer);
                
                await sendSignal('offer', offer);
                currentUser.log('‚úÖ Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ WebRTC: ${error.message}`, 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ offer
        async function handleOffer(signal) {
            if (currentUser.state !== 'connecting' || currentUser.targetUser !== signal.from) {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º offer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}, target: ${currentUser.targetUser}`, 'warning');
                return;
            }
            
            currentUser.log(`üì• –ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${signal.from}`, 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–æ–≤
            if (!currentUser.localStream) {
                currentUser.log(`‚ùå –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ PeerConnection (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)`, 'error');
                return;
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º PeerConnection
                currentUser.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                currentUser.localStream.getTracks().forEach(track => {
                    currentUser.peerConnection.addTrack(track, currentUser.localStream);
                    currentUser.log(`üìπ –î–æ–±–∞–≤–ª–µ–Ω —Ç—Ä–µ–∫: ${track.kind} (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)`, 'info');
                });
                currentUser.log(`üìπ –î–æ–±–∞–≤–ª–µ–Ω–æ ${currentUser.localStream.getTracks().length} —Ç—Ä–µ–∫–æ–≤ –≤ PeerConnection (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)`, 'success');
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                currentUser.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        sendSignal('ice-candidate', event.candidate);
                    }
                };
                
                currentUser.peerConnection.ontrack = (event) => {
                    currentUser.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)', 'success');
                    currentUser.log(`üìπ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤: ${event.streams.length} (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)`, 'info');
                    currentUser.log(`üìπ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤: ${event.track.kind} (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)`, 'info');
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                };
                
                currentUser.peerConnection.onconnectionstatechange = () => {
                    currentUser.log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${currentUser.peerConnection.connectionState}`, 'info');
                    if (currentUser.peerConnection.connectionState === 'connected') {
                        currentUser.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                        currentUser.state = 'calling';
                        updateUI();
                    }
                };
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await currentUser.peerConnection.setRemoteDescription(signal.data);
                
                // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                const answer = await currentUser.peerConnection.createAnswer();
                await currentUser.peerConnection.setLocalDescription(answer);
                
                await sendSignal('answer', answer);
                currentUser.log('‚úÖ Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–≤–µ—Ä—à–∏—Ç—å" —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                const disconnectBtn = document.getElementById(`disconnectBtn_${signal.from}`);
                const callBtn = document.getElementById(`callBtn_${signal.from}`);
                
                if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
                if (callBtn) callBtn.style.display = 'none';
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${error.message}`, 'error');
            }
        }
        
        // –ü—Ä–∏–Ω—è—Ç–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        async function acceptIncomingCall() {
            if (!incomingCall.isActive) return;
            
            currentUser.log(`‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ–º –∑–≤–æ–Ω–æ–∫ –æ—Ç ${incomingCall.caller}`, 'success');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º pong –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞
            sendCallsWebSocketMessage('pong', { received: true }, incomingCall.caller);
            currentUser.log('‚úÖ pong –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            currentUser.state = 'connecting';
            currentUser.targetUser = incomingCall.caller;
            currentUser.isInitiator = false;
            currentUser.webrtcInitiated = false;
            updateUI();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            hideIncomingCallModal();
            
            currentUser.log(`‚è≥ –ñ–¥–µ–º offer –æ—Ç ${incomingCall.caller}...`, 'info');
        }
        
        // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        async function rejectIncomingCall() {
            if (!incomingCall.isActive) return;
            
            currentUser.log(`‚ùå –û—Ç–∫–ª–æ–Ω—è–µ–º –∑–≤–æ–Ω–æ–∫ –æ—Ç ${incomingCall.caller}`, 'warning');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
            if (currentUser.localStream) {
                currentUser.localStream.getTracks().forEach(track => track.stop());
                currentUser.localStream = null;
                document.getElementById('localVideo').srcObject = null;
                currentUser.log('üìπ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'info');
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º disconnect —Å–∏–≥–Ω–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É –∑–≤–æ–Ω–∫–∞
            sendCallsWebSocketMessage('disconnect', { reason: 'call_rejected' }, incomingCall.caller);
            
            // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            hideIncomingCallModal();
        }
        
        // –°–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        function hideIncomingCallModal() {
            document.getElementById('incomingCallModal').style.display = 'none';
            incomingCall.isActive = false;
            incomingCall.caller = null;
            incomingCall.offer = null;
            incomingCall.iceCandidates = [];
            
            // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
            if (incomingCall.callTimeout) {
                clearTimeout(incomingCall.callTimeout);
                incomingCall.callTimeout = null;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ answer
        async function handleAnswer(signal) {
            if (currentUser.state !== 'connected') {
                currentUser.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º answer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${currentUser.state}`, 'warning');
                return;
            }

            currentUser.log(`üì• –ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${signal.from}`, 'info');
            
            try {
                if (currentUser.peerConnection) {
                    await currentUser.peerConnection.setRemoteDescription(signal.data);
                    currentUser.log('‚úÖ Offer/Answer –æ–±–º–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
                    currentUser.state = 'calling';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–≤–µ—Ä—à–∏—Ç—å" —É –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
                    const disconnectBtn = document.getElementById(`disconnectBtn_${signal.from}`);
                    const callBtn = document.getElementById(`callBtn_${signal.from}`);
                    
                    if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
                    if (callBtn) callBtn.style.display = 'none';
                    
                    updateUI();
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer: ${error.message}`, 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        async function handleIceCandidate(signal) {
            if (currentUser.peerConnection) {
                try {
                    await currentUser.peerConnection.addIceCandidate(signal.data);
                    currentUser.log(`üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç ${signal.from}`, 'info');
                                } catch (error) {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`, 'error');
                }
                            } else {
                currentUser.log(`‚ö†Ô∏è PeerConnection –Ω–µ —Å–æ–∑–¥–∞–Ω, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç`, 'warning');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ disconnect
        async function handleDisconnect(signal) {
            currentUser.log(`üì• –ü–æ–ª—É—á–µ–Ω disconnect –æ—Ç ${signal.from}`, 'warning');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –æ—Ç —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ—Ç —Ç–æ–≥–æ, –∫—Ç–æ –∑–≤–æ–Ω–∏–ª
            if (currentUser.targetUser === signal.from || (incomingCall.isActive && incomingCall.caller === signal.from)) {
                
                // –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ –Ω–∞ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏
                if (signal.data && signal.data.reason === 'call_rejected') {
                    currentUser.log(`‚ùå –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${signal.from}`, 'warning');
                            } else {
                    currentUser.log(`üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ`, 'warning');
                }
                
                // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–≤–æ–Ω–æ–∫, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (currentUser.peerConnection) {
                    currentUser.peerConnection.close();
                    currentUser.peerConnection = null;
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                if (currentUser.localStream) {
                    currentUser.localStream.getTracks().forEach(track => track.stop());
                    currentUser.localStream = null;
                    document.getElementById('localVideo').srcObject = null;
                    currentUser.log('üìπ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'info');
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥—Ä—É–∑–µ–π
                restoreFriendButtons();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
                currentUser.state = 'idle';
                currentUser.targetUser = null;
                currentUser.isInitiator = false;
                currentUser.webrtcInitiated = false;
                
                document.getElementById('remoteVideo').srcObject = null;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞ –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                if (incomingCall.isActive) {
                    hideIncomingCallModal();
                }
                
                updateUI();
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ WebSocket –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤
        function sendSignal(type, data) {
            sendCallsWebSocketMessage(type, data);
        }
        
        // ===== –°–ò–°–¢–ï–ú–ê –°–û–û–ë–©–ï–ù–ò–ô =====
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —á–∞—Ç–∞
        let currentChatFriend = null;
        let chatMessages = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –¥—Ä—É–∑—å—è–º
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ —Å –¥—Ä—É–≥–æ–º
        function openChat(friendUsername) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞
            const chatUrl = `chat.php?userId=${encodeURIComponent(currentUser.id)}&friend=${encodeURIComponent(friendUsername)}`;
            window.open(chatUrl, 'chat_' + friendUsername, 'width=800,height=600,scrollbars=yes,resizable=yes');
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
        function closeChat() {
            document.getElementById('chatModal').style.display = 'none';
            document.getElementById('emojiPanel').style.display = 'none';
            currentChatFriend = null;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadChatHistory(friendUsername) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ localStorage
            const messages = chatMessages[friendUsername] || [];
            
            messages.forEach(message => {
                addMessageToChat(message.text, message.from, message.timestamp, message.type);
            });
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessageToChat(text, from, timestamp, type = 'text') {
            const messagesContainer = document.getElementById('chatMessages');
            const isOwn = from === currentUser.id;
            
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                margin: 10px 0;
                display: flex;
                justify-content: ${isOwn ? 'flex-end' : 'flex-start'};
            `;
            
            const messageBubble = document.createElement('div');
            messageBubble.style.cssText = `
                max-width: 70%;
                padding: 10px 15px;
                border-radius: 15px;
                background: ${isOwn ? '#2196F3' : '#e0e0e0'};
                color: ${isOwn ? 'white' : 'black'};
                word-wrap: break-word;
            `;
            
            if (type === 'emoji') {
                messageBubble.style.fontSize = '24px';
                messageBubble.textContent = text;
            } else {
                messageBubble.textContent = text;
            }
            
            messageDiv.appendChild(messageBubble);
            messagesContainer.appendChild(messageDiv);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentChatFriend) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
            const timestamp = Date.now();
            addMessageToChat(message, currentUser.id, timestamp, 'text');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            if (!chatMessages[currentChatFriend]) {
                chatMessages[currentChatFriend] = [];
            }
            chatMessages[currentChatFriend].push({
                text: message,
                from: currentUser.id,
                timestamp: timestamp,
                type: 'text'
            });
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ PHP API
            try {
                const response = await fetch('chat-api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'send_message',
                        from: currentUser.id,
                        to: currentChatFriend,
                        message: message
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser.log(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ API`, 'success');
                } else {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.message}`, 'error');
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
            }
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.value = '';
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —ç–º–æ–¥–∑–∏
        async function sendEmoji(emoji) {
            if (!currentChatFriend) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –≤ —á–∞—Ç
            const timestamp = Date.now();
            addMessageToChat(emoji, currentUser.id, timestamp, 'emoji');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            if (!chatMessages[currentChatFriend]) {
                chatMessages[currentChatFriend] = [];
            }
            chatMessages[currentChatFriend].push({
                text: emoji,
                from: currentUser.id,
                timestamp: timestamp,
                type: 'emoji'
            });
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ PHP API
            try {
                const response = await fetch('chat-api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'send_emoji',
                        from: currentUser.id,
                        to: currentChatFriend,
                        emoji: emoji
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUser.log(`‚úÖ –≠–º–æ–¥–∑–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ API`, 'success');
                } else {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —ç–º–æ–¥–∑–∏: ${result.message}`, 'error');
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏
            document.getElementById('emojiPanel').style.display = 'none';
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —ç–º–æ–¥–∑–∏
        function toggleEmojiPanel() {
            const emojiPanel = document.getElementById('emojiPanel');
            emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'block' : 'none';
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function handleChatMessage(signal) {
            if (!currentChatFriend || signal.from !== currentChatFriend) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
            addMessageToChat(signal.data.message, signal.from, signal.data.timestamp, signal.data.type);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            if (!chatMessages[currentChatFriend]) {
                chatMessages[currentChatFriend] = [];
            }
            chatMessages[currentChatFriend].push({
                text: signal.data.message,
                from: signal.from,
                timestamp: signal.data.timestamp,
                type: signal.data.type
            });
            localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ localStorage –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        function loadChatMessagesFromStorage() {
            const stored = localStorage.getItem('chatMessages');
            if (stored) {
                chatMessages = JSON.parse(stored);
            }
        }
        
        
        // –†–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function disconnectCall() {
            currentUser.log('üîå –†–∞–∑—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'warning');
            
            if (currentUser.peerConnection) {
                currentUser.peerConnection.close();
                currentUser.peerConnection = null;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º disconnect —Å–∏–≥–Ω–∞–ª
            if (currentUser.targetUser) {
                await sendSignal('disconnect', { reason: 'user_disconnected' });
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
            if (currentUser.localStream) {
                currentUser.localStream.getTracks().forEach(track => track.stop());
                currentUser.localStream = null;
                document.getElementById('localVideo').srcObject = null;
                currentUser.log('üìπ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'info');
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥—Ä—É–∑–µ–π
            restoreFriendButtons();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–∞, –Ω–µ –≤–µ—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            currentUser.state = 'idle';
            currentUser.targetUser = null;
            currentUser.isInitiator = false;
            currentUser.webrtcInitiated = false;
            
            document.getElementById('remoteVideo').srcObject = null;
            
            updateUI();
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞ (—Ç–æ–ª—å–∫–æ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
        async function endCall() {
            currentUser.log('üîå –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–≤–æ–Ω–æ–∫', 'warning');
            
            if (currentUser.peerConnection) {
                currentUser.peerConnection.close();
                currentUser.peerConnection = null;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º disconnect —Å–∏–≥–Ω–∞–ª
            if (currentUser.targetUser) {
                await sendSignal('disconnect', { reason: 'user_disconnected' });
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
            if (currentUser.localStream) {
                currentUser.localStream.getTracks().forEach(track => track.stop());
                currentUser.localStream = null;
                document.getElementById('localVideo').srcObject = null;
                currentUser.log('üìπ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'info');
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥—Ä—É–∑–µ–π
            restoreFriendButtons();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤–æ–Ω–∫–∞, –Ω–µ –≤–µ—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            currentUser.state = 'idle';
            currentUser.targetUser = null;
            currentUser.isInitiator = false;
            currentUser.webrtcInitiated = false;
            
            document.getElementById('remoteVideo').srcObject = null;
            
            updateUI();
        }
        
        // –°–±—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function resetUser() {
            if (currentUser.peerConnection) {
                currentUser.peerConnection.close();
                currentUser.peerConnection = null;
            }
            
            if (currentUser.localStream) {
                currentUser.localStream.getTracks().forEach(track => track.stop());
                currentUser.localStream = null;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (currentUser.callsWs) {
                currentUser.callsWs.close();
                currentUser.callsWs = null;
                currentUser.callsWsConnected = false;
                currentUser.wsUserId = null;
            }
            if (currentUser.chatWs) {
                currentUser.chatWs.close();
                currentUser.chatWs = null;
                currentUser.chatWsConnected = false;
            }
            
            currentUser.state = 'idle';
            currentUser.targetUser = null;
            currentUser.isInitiator = false;
            currentUser.webrtcInitiated = false;
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            currentUser.log('üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–±—Ä–æ—à–µ–Ω', 'warning');
            
            // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            localStorage.removeItem('userData');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥—Ä—É–∑–µ–π
            restoreFriendButtons();
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É –¥—Ä—É–∑–µ–π
            hideFriendsSection();
            
            updateUI();
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤
        function copyLogs() {
            const log = document.getElementById('log').innerText;
            const allLogs = `=== –õ–û–ì–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===\n${log}\n\n=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–ï–°–¢–ï ===\n–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞: ${new Date().toLocaleString()}\n–°–µ—Ä–≤–µ—Ä: ${WEBSOCKET_URL}\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser.id || '–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}`;
            
            navigator.clipboard.writeText(allLogs).then(() => {
                alert('–õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }
        
        // ===== –°–ò–°–¢–ï–ú–ê –î–†–£–ó–ï–ô =====
        
        // –î–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –¥—Ä—É–∑–µ–π
        let friendsData = {
            friends: [],           // –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
            requests: [],          // –í—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
            sentRequests: []       // –ò—Å—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
        };
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
        let incomingCall = {
            isActive: false,
            caller: null,
            offer: null,
            iceCandidates: [],  // –ë—É—Ñ–µ—Ä –¥–ª—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            maxIceCandidates: 10,  // –ú–∞–∫—Å–∏–º—É–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ –±—É—Ñ–µ—Ä–µ
            callTimeout: null  // –¢–∞–π–º–∞—É—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
        };
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ü–∏—é –¥—Ä—É–∑–µ–π –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showFriendsSection() {
            document.getElementById('friendsSection').style.display = 'block';
            loadFriendsData();
        }
        
        // –°–∫—Ä—ã—Ç—å —Å–µ–∫—Ü–∏—é –¥—Ä—É–∑–µ–π –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
        function hideFriendsSection() {
            document.getElementById('friendsSection').style.display = 'none';
        }
        
        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function searchUser() {
            const username = document.getElementById('searchUsername').value.trim();
            if (!username) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            if (username === currentUser.id) {
                alert('–ù–µ–ª—å–∑—è –∏—Å–∫–∞—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è');
                return;
            }
            
            currentUser.log(`üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${username}`, 'info');
            
            try {
                // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API
                const response = await fetch(`https://lizaapp.wg01.ru/api/search_user.php?username=${encodeURIComponent(username)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user) {
                        displaySearchResult(data.user);
                    } else {
                        currentUser.log(`‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'error');
                        document.getElementById('searchResults').innerHTML = '<p style="color: red;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
                    }
            } else {
                    const errorText = await response.text();
                    currentUser.log(`‚ùå HTTP –æ—à–∏–±–∫–∞: ${response.status} - ${errorText}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}`, 'error');
                document.getElementById('searchResults').innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>';
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞
        function displaySearchResult(user) {
            const searchResults = document.getElementById('searchResults');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –¥—Ä—É–≥–æ–º –∏–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
            const isFriend = friendsData.friends.some(f => f.username === user.username);
            const hasRequest = friendsData.requests.some(r => r.username === user.username);
            const hasSentRequest = friendsData.sentRequests.some(r => r.username === user.username);
            
            let buttonHtml = '';
            if (isFriend) {
                buttonHtml = '<span style="color: green;">‚úì –£–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö</span>';
            } else if (hasRequest) {
                buttonHtml = '<span style="color: orange;">üì® –ï—Å—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å</span>';
            } else if (hasSentRequest) {
                buttonHtml = '<span style="color: blue;">üì§ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>';
                } else {
                buttonHtml = `<button onclick="sendFriendRequest('${user.username}')" class="btn-success btn-small">üë• –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>`;
            }
            
            searchResults.innerHTML = `
                <div class="user-item">
                    <div class="username">üë§ ${user.username}</div>
                    <div class="actions">${buttonHtml}</div>
                </div>
            `;
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è
        async function sendFriendRequest(username) {
            currentUser.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è: ${username}`, 'info');
            
            try {
                const response = await fetch('https://lizaapp.wg01.ru/api/send_invitation.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        from_username: currentUser.id,
                        target_username: username
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentUser.log(`‚úÖ –ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${username}`, 'success');
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                        friendsData.sentRequests.push({
                            username: username,
                            timestamp: new Date().toISOString()
                        });
                        
                        updateSentRequestsList();
                        document.getElementById('searchResults').innerHTML = '<p style="color: green;">–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</p>';
                } else {
                        currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: ${data.message}`, 'error');
                        alert(data.message);
                    }
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞');
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π
        async function loadFriendsData() {
            if (!currentUser.id) return;
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–∑–µ–π
                const friendsResponse = await fetch(`https://lizaapp.wg01.ru/api/get_contacts.php?username=${currentUser.id}`, {
                    method: 'GET'
                });
                if (friendsResponse.ok) {
                    const friendsResponseData = await friendsResponse.json();
                    if (friendsResponseData.success) {
                        friendsData.friends = friendsResponseData.contacts || [];
                        updateFriendsList();
                    }
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
                const requestsResponse = await fetch(`https://lizaapp.wg01.ru/api/get_requests.php?username=${currentUser.id}`, {
                    method: 'GET'
                });
                if (requestsResponse.ok) {
                    const requestsResponseData = await requestsResponse.json();
                    if (requestsResponseData.success) {
                        friendsData.requests = requestsResponseData.requests || [];
                        updateRequestsList();
                    }
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
                const sentRequestsResponse = await fetch(`https://lizaapp.wg01.ru/api/get_sent_requests.php?username=${currentUser.id}`, {
                    method: 'GET'
                });
                if (sentRequestsResponse.ok) {
                    const sentRequestsResponseData = await sentRequestsResponse.json();
                    if (sentRequestsResponseData.success) {
                        friendsData.sentRequests = sentRequestsResponseData.requests || [];
                        updateSentRequestsList();
                    }
                }
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π: ${error.message}`, 'error');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π
        function updateFriendsList() {
            const friendsList = document.getElementById('friendsList');
            
            if (friendsData.friends.length === 0) {
                friendsList.innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">–ù–µ—Ç –¥—Ä—É–∑–µ–π</p>';
                return;
            }
            
            const friendsHtml = friendsData.friends.map(friend => `
                <div class="friend-item">
                    <div class="username">üë§ ${friend.username}</div>
                    <div class="actions">
                        <button onclick="callFriend('${friend.username}')" class="btn-primary btn-small" id="callBtn_${friend.username}">üìû –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</button>
                        <button onclick="callFriendAudio('${friend.username}')" class="btn-secondary btn-small" id="audioCallBtn_${friend.username}">üéµ –ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫</button>
                        <button onclick="openChat('${friend.username}')" class="btn-info btn-small" id="chatBtn_${friend.username}">üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ</button>
                        <button onclick="endCall()" class="btn-danger btn-small" id="disconnectBtn_${friend.username}" style="display: none;">üîå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
            
            friendsList.innerHTML = friendsHtml;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        function updateRequestsList() {
            const requestsList = document.getElementById('requestsList');
            
            if (friendsData.requests.length === 0) {
                requestsList.innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤</p>';
                return;
            }
            
            const requestsHtml = friendsData.requests.map(request => `
                <div class="request-item">
                    <div class="username">üë§ ${request.username}</div>
                    <div class="actions">
                        <button onclick="acceptFriendRequest('${request.username}')" class="btn-success btn-small">‚úì</button>
                        <button onclick="rejectFriendRequest('${request.username}')" class="btn-danger btn-small">‚úó</button>
                    </div>
                </div>
            `).join('');
            
            requestsList.innerHTML = requestsHtml;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        function updateSentRequestsList() {
            const sentRequestsList = document.getElementById('sentRequestsList');
            
            if (friendsData.sentRequests.length === 0) {
                sentRequestsList.innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</p>';
                return;
            }
            
            const sentRequestsHtml = friendsData.sentRequests.map(request => `
                <div class="request-item">
                    <div class="username">üë§ ${request.username}</div>
                    <div class="actions">
                        <span style="color: #666; font-size: 12px;">–û–∂–∏–¥–∞–µ—Ç</span>
                    </div>
                </div>
            `).join('');
            
            sentRequestsList.innerHTML = sentRequestsHtml;
        }
        
        // –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è
        async function acceptFriendRequest(username) {
            currentUser.log(`‚úÖ –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è: ${username}`, 'info');
            
            try {
                const response = await fetch('https://lizaapp.wg01.ru/api/accept_invitation.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        accepter_username: currentUser.id,
                        sender_username: username
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentUser.log(`‚úÖ –ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –ø—Ä–∏–Ω—è—Ç: ${username}`, 'success');
                        
                        // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                        friendsData.requests = friendsData.requests.filter(r => r.username !== username);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –¥—Ä—É–∑—å—è
                        friendsData.friends.push({
                            username: username,
                            timestamp: new Date().toISOString()
                        });
                        
                        updateRequestsList();
                        updateFriendsList();
                    } else {
                        currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–ø—Ä–æ—Å–∞: ${data.message}`, 'error');
                        alert(data.message);
                    }
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–ø—Ä–æ—Å–∞');
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–ø—Ä–æ—Å–∞');
            }
        }
        
        // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è
        async function rejectFriendRequest(username) {
            currentUser.log(`‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è: ${username}`, 'warning');
            
            try {
                const response = await fetch('https://lizaapp.wg01.ru/api/reject_invitation.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rejecter_username: currentUser.id,
                        sender_username: username
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        currentUser.log(`‚úÖ –ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–∫–ª–æ–Ω–µ–Ω: ${username}`, 'success');
                        
                        // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                        friendsData.requests = friendsData.requests.filter(r => r.username !== username);
                        
                        updateRequestsList();
                } else {
                        currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: ${data.message}`, 'error');
                        alert(data.message);
                    }
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞');
                }
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
                alert('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞');
            }
        }
        
        // –ê—É–¥–∏–æ –∑–≤–æ–Ω–æ–∫ –¥—Ä—É–≥—É
        async function callFriendAudio(username) {
            currentUser.log(`üéµ –ê—É–¥–∏–æ –∑–≤–æ–Ω–æ–∫ –¥—Ä—É–≥—É: ${username}`, 'info');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ "–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫" –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
            const audioCallBtn = document.getElementById(`audioCallBtn_${username}`);
            const disconnectBtn = document.getElementById(`disconnectBtn_${username}`);
            
            if (audioCallBtn) audioCallBtn.style.display = 'none';
            if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∏ —É –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
            try {
                currentUser.log(`üéµ –ó–∞–ø—É—Å–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...`, 'info');
                currentUser.localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: false,  // –¢–æ–ª—å–∫–æ –∞—É–¥–∏–æ!
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = currentUser.localStream;
                currentUser.log(`‚úÖ –ê—É–¥–∏–æ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω: ${currentUser.localStream.getTracks().length} —Ç—Ä–µ–∫–æ–≤ (–∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä)`, 'success');
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ —Ç—Ä–µ–∫–æ–≤
                currentUser.localStream.getTracks().forEach(track => {
                    currentUser.log(`üéµ –¢—Ä–µ–∫: ${track.kind}, enabled: ${track.enabled}, readyState: ${track.readyState} (–∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä)`, 'info');
                });
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∑–≤–æ–Ω–∫–æ–≤, –Ω–æ —Å –∞—É–¥–∏–æ —Ç–∏–ø–æ–º
                document.getElementById('targetUserId').value = username;
                startAudioCall();
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞—É–¥–∏–æ: ${error.message}`, 'error');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                if (audioCallBtn) audioCallBtn.style.display = 'inline-block';
                if (disconnectBtn) disconnectBtn.style.display = 'none';
            }
        }
        
        // –ó–≤–æ–Ω–æ–∫ –¥—Ä—É–≥—É
        async function callFriend(username) {
            currentUser.log(`üìû –ó–≤–æ–Ω–æ–∫ –¥—Ä—É–≥—É: ${username}`, 'info');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫" –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
            const callBtn = document.getElementById(`callBtn_${username}`);
            const disconnectBtn = document.getElementById(`disconnectBtn_${username}`);
            
            if (callBtn) callBtn.style.display = 'none';
            if (disconnectBtn) disconnectBtn.style.display = 'inline-block';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ —É –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
            try {
                currentUser.log(`üìπ –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...`, 'info');
                currentUser.localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = currentUser.localStream;
                currentUser.log(`‚úÖ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã: ${currentUser.localStream.getTracks().length} —Ç—Ä–µ–∫–æ–≤ (–∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä)`, 'success');
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ —Ç—Ä–µ–∫–æ–≤
                currentUser.localStream.getTracks().forEach(track => {
                    currentUser.log(`üìπ –¢—Ä–µ–∫: ${track.kind}, enabled: ${track.enabled}, readyState: ${track.readyState} (–∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä)`, 'info');
                });
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∑–≤–æ–Ω–∫–æ–≤
                document.getElementById('targetUserId').value = username;
                startCall();
                
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                if (callBtn) callBtn.style.display = 'inline-block';
                if (disconnectBtn) disconnectBtn.style.display = 'none';
            }
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥—Ä—É–∑–µ–π –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
        function restoreFriendButtons() {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –¥—Ä—É–∑–µ–π
            friendsData.friends.forEach(friend => {
                const callBtn = document.getElementById(`callBtn_${friend.username}`);
                const audioCallBtn = document.getElementById(`audioCallBtn_${friend.username}`);
                const disconnectBtn = document.getElementById(`disconnectBtn_${friend.username}`);
                
                if (callBtn) callBtn.style.display = 'inline-block';
                if (audioCallBtn) audioCallBtn.style.display = 'inline-block';
                if (disconnectBtn) disconnectBtn.style.display = 'none';
            });
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
        function restoreUserData() {
            const userData = localStorage.getItem('userData');
            if (userData) {
                try {
                    const data = JSON.parse(userData);
                    if (data.username && data.sessionToken) {
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                        document.getElementById('userId').value = data.username;
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        currentUser.id = data.username;
                        currentUser.sessionToken = data.sessionToken;
                        currentUser.userId = data.userId;
                        
                        currentUser.log(`üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${data.username}`, 'info');
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
                        autoConnect();
                        return true;
                }
            } catch (error) {
                    currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                    localStorage.removeItem('userData');
                }
            }
            return false;
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function autoConnect() {
            currentUser.log(`üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...`, 'info');
            
            currentUser.lastSignalId = Math.floor(Date.now() / 1000) - 60;
            currentUser.state = 'idle';
            currentUser.targetUser = null;
            currentUser.isInitiator = false;
            currentUser.webrtcInitiated = false;
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä–∞–º
            try {
                await connectCallsWebSocket();
            } catch (error) {
                currentUser.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket: ${error.message}`, 'error');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É –¥—Ä—É–∑–µ–π
            showFriendsSection();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ localStorage
            loadChatMessagesFromStorage();
            
            currentUser.log(`üìπ –ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –±—É–¥—É—Ç –∑–∞–ø—É—â–µ–Ω—ã –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ`, 'info');
            
            currentUser.log(`üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${currentUser.id} –≥–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º`, 'success');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (!restoreUserData()) {
                currentUser.log('üîê –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'info');
            }
        });
    </script>
</body>
</html>
