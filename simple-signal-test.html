<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç —Å–∏–≥–Ω–∞–ª–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .user-section { border: 1px solid #ccc; padding: 20px; margin: 10px 0; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; }
        input { padding: 5px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –æ–±–º–µ–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞–º–∏</h1>
        
        <div class="user-section">
            <h2>User 1</h2>
            <input type="text" id="user1Id" value="user1" placeholder="User ID">
            <button onclick="startUser1()">–ó–∞–ø—É—Å—Ç–∏—Ç—å User 1</button>
            <button onclick="sendPing1()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å ping –∫ user2</button>
            <button onclick="resetUser1()" style="background: #ff9800; color: white;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
            
        <div style="margin: 10px 0;">
            <button onclick="testOffer1()" id="offerBtn1" disabled style="background: #2196F3; color: white; display: none;">üì§ –¢–µ—Å—Ç Offer</button>
            <button onclick="disconnectCall()" id="disconnectBtn1" disabled style="background: #f44336; color: white; display: none;">üîå –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
        </div>
            
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <video id="localVideo1" autoplay muted style="width: 200px; height: 150px; border: 2px solid #4CAF50; background: #000;"></video>
                <video id="remoteVideo1" autoplay style="width: 200px; height: 150px; border: 2px solid #2196F3; background: #000;"></video>
            </div>
            
            <div id="log1" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>User 2</h2>
            <input type="text" id="user2Id" value="user2" placeholder="User ID">
            <button onclick="startUser2()">–ó–∞–ø—É—Å—Ç–∏—Ç—å User 2</button>
            <button onclick="sendPing2()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å ping –∫ user1</button>
            <button onclick="resetUser2()" style="background: #ff9800; color: white;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
            
        <div style="margin: 10px 0;">
            <button onclick="testAnswer2()" id="answerBtn2" disabled style="background: #4CAF50; color: white; display: none;">üì• –¢–µ—Å—Ç Answer (—Ä—É—á–Ω–æ–π)</button>
            <div id="autoAnswerInfo" style="display: none; color: #4CAF50; font-weight: bold;">ü§ñ Answer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ offer</div>
        </div>
            
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <video id="localVideo2" autoplay muted style="width: 200px; height: 150px; border: 2px solid #4CAF50; background: #000;"></video>
                <video id="remoteVideo2" autoplay style="width: 200px; height: 150px; border: 2px solid #2196F3; background: #000;"></video>
            </div>
            
            <div id="log2" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤</h2>
            <button onclick="copyAllLogs()" style="background: #4CAF50; color: white; font-weight: bold;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ª–æ–≥–∏</button>
            <p>–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å–∫–æ–ø–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É</p>
        </div>
    </div>

    <script>
        const SIGNALING_SERVER = 'https://lizamsg.ru:3000/api/signaling';
        
        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { 
                    urls: 'turn:turn.lizaapp.wg01.ru:3478',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                }
            ]
        };
        
        let user1 = {
            id: 'user1',
            lastSignalId: 0,
            interval: null,
            state: 'idle', // idle, connecting, connected, calling
            targetUser: null,
            peerConnection: null,
            localStream: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log1');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        let user2 = {
            id: 'user2',
            lastSignalId: 0,
            interval: null,
            state: 'idle', // idle, connecting, connected, calling
            targetUser: null,
            peerConnection: null,
            localStream: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log2');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        async         function startUser1() {
            user1.id = document.getElementById('user1Id').value;
            user1.lastSignalId = Math.floor(Date.now() / 1000) - 60; // –ü–æ–ª—É—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
            user1.state = 'idle';
            user1.targetUser = null;
            user1.log(`üöÄ –ó–∞–ø—É—Å–∫ User 1: ${user1.id}`, 'success');
            user1.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—à–µ: ${user1.lastSignalId}`, 'info');
            user1.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${user1.state}`, 'info');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC
            await initWebRTC(user1);
            
            if (user1.interval) clearInterval(user1.interval);
            user1.interval = setInterval(() => checkSignals(user1), 2000);
            checkSignals(user1);
        }
        
        async         function startUser2() {
            user2.id = document.getElementById('user2Id').value;
            user2.lastSignalId = Math.floor(Date.now() / 1000) - 60; // –ü–æ–ª—É—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
            user2.state = 'idle';
            user2.targetUser = null;
            user2.log(`üöÄ –ó–∞–ø—É—Å–∫ User 2: ${user2.id}`, 'success');
            user2.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—à–µ: ${user2.lastSignalId}`, 'info');
            user2.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${user2.state}`, 'info');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC
            await initWebRTC(user2);
            
            if (user2.interval) clearInterval(user2.interval);
            user2.interval = setInterval(() => checkSignals(user2), 2000);
            checkSignals(user2);
        }
        
        async function sendPing1() {
            if (user1.state !== 'idle') {
                user1.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ping - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user1.state}`, 'warning');
                return;
            }
            user1.state = 'connecting';
            user1.targetUser = user2.id;
            user1.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user1.state}`, 'info');
            await sendSignal(user1, user2.id, 'ping', { test: true });
        }
        
        async function sendPing2() {
            if (user2.state !== 'idle') {
                user2.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ping - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user2.state}`, 'warning');
                return;
            }
            user2.state = 'connecting';
            user2.targetUser = user1.id;
            user2.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user2.state}`, 'info');
            await sendSignal(user2, user1.id, 'ping', { test: true });
        }
        
        async function sendSignal(user, to, type, data) {
            try {
                user.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${type} –∫ ${to}`, 'warning');
                
                // –õ–æ–≥–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
                const dataSize = JSON.stringify(data).length;
                user.log(`üì§ –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: ${dataSize} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
                
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: user.id,
                        to: to,
                        type: type,
                        data: data
                    })
                });
                
                const result = await response.json();
                user.log(`üì° –û—Ç–≤–µ—Ç: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    user.log(`‚úÖ ${type} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                } else {
                    user.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.error}`, 'error');
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function checkSignals(user) {
            try {
                const url = `${SIGNALING_SERVER}?action=signals&userId=${user.id}&since=${user.lastSignalId}`;
                user.log(`üîç –ó–∞–ø—Ä–æ—Å: ${url}`, 'info');
                
                const response = await fetch(url);
                const data = await response.json();
                
                user.log(`üì° –û—Ç–≤–µ—Ç: ${JSON.stringify(data)}`, 'info');
                
                if (data.success && data.signals && data.signals.length > 0) {
                    user.log(`üì® –ü–æ–ª—É—á–µ–Ω–æ ${data.signals.length} —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï —Å–∏–≥–Ω–∞–ª—ã (–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
                    const newSignals = data.signals.filter(signal => {
                        const signalTimestamp = signal.timestamp || signal.id;
                        const isNew = signalTimestamp > user.lastSignalId;
                        if (!isNew) {
                            user.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–π —Å–∏–≥–Ω–∞–ª: ${signal.type} –æ—Ç ${signal.from} (timestamp: ${signalTimestamp} <= ${user.lastSignalId})`, 'warning');
                        }
                        return isNew;
                    });
                    
                    if (newSignals.length === 0) {
                        user.log(`üîç –í—Å–µ —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—ã–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º`, 'info');
                        // –û–±–Ω–æ–≤–ª—è–µ–º lastSignalId –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                        const maxTimestamp = Math.max(...data.signals.map(s => s.timestamp || s.id));
                        user.lastSignalId = Math.max(user.lastSignalId, maxTimestamp);
                        return;
                    }
                    
                    user.log(`üì® –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${newSignals.length} –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
                    
                    newSignals.forEach(signal => {
                        user.lastSignalId = Math.max(user.lastSignalId, signal.timestamp || signal.id);
                        user.log(`üì® ${signal.type} –æ—Ç ${signal.from}`, 'success');
                        
                        if (signal.type === 'ping') {
                            if (user.state === 'idle') {
                                user.log(`üèì –ü–æ–ª—É—á–µ–Ω ping –æ—Ç ${signal.from} - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º pong`, 'warning');
                                user.state = 'connecting';
                                user.targetUser = signal.from;
                                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'info');
                                sendSignal(user, signal.from, 'pong', { received: true });
                                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ connected –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ pong
                                user.state = 'connected';
                                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'success');
                                user.log(`üîó P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è WebRTC!`, 'success');
                                updateCallButtons(user);
                            } else {
                                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ping –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'warning');
                            }
                        } else if (signal.type === 'pong') {
                            if (user.state === 'connecting' && user.targetUser === signal.from) {
                                user.log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} - —Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!`, 'success');
                                user.state = 'connected';
                                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'success');
                                user.log(`üîó P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è WebRTC!`, 'success');
                                user.log(`üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫" –¥–ª—è WebRTC`, 'info');
                                updateCallButtons(user);
                            } else if (user.state === 'connected' && user.targetUser === signal.from) {
                                user.log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} - —Å–≤—è–∑—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`, 'info');
                            } else {
                                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º pong –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}, –æ–∂–∏–¥–∞–ª–∏: ${user.targetUser}`, 'warning');
                            }
        } else if (signal.type === 'offer') {
            user.log(`üì• –ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${signal.from}`, 'warning');
            user.log(`üì• Offer –¥–∞–Ω–Ω—ã–µ: type=${signal.data.type}, sdp –¥–ª–∏–Ω–∞=${signal.data.sdp ? signal.data.sdp.length : 'undefined'}`, 'info');
            user.log(`üì• –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${user.state}`, 'info');
            handleOffer(user, signal);
                        } else if (signal.type === 'answer') {
                            user.log(`üì• –ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${signal.from}`, 'warning');
                            user.log(`üì• Answer –¥–∞–Ω–Ω—ã–µ: type=${signal.data.type}, sdp –¥–ª–∏–Ω–∞=${signal.data.sdp ? signal.data.sdp.length : 'undefined'}`, 'info');
                            handleAnswer(user, signal);
                        } else if (signal.type === 'ice-candidate') {
                            handleIceCandidate(user, signal);
                        } else if (signal.type === 'disconnect') {
                            handleDisconnect(user, signal);
                        }
                    });
                } else {
                    user.log(`üîç –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤`, 'info');
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, 'error');
            }
        }
        
        function copyAllLogs() {
            try {
                const log1 = document.getElementById('log1').innerText;
                const log2 = document.getElementById('log2').innerText;
                
                const allLogs = `=== –õ–û–ì–ò USER 1 ===\n${log1}\n\n=== –õ–û–ì–ò USER 2 ===\n${log2}\n\n=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–ï–°–¢–ï ===\n–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞: ${new Date().toLocaleString()}\n–°–µ—Ä–≤–µ—Ä: ${SIGNALING_SERVER}\nUser 1 ID: ${user1.id}\nUser 2 ID: ${user2.id}`;
                
                // –ü—Ä–æ–±—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(allLogs).then(() => {
                        showCopySuccess();
                    }).catch(err => {
                        console.error('–û—à–∏–±–∫–∞ clipboard API: ', err);
                        fallbackCopy(allLogs);
                    });
                } else {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    fallbackCopy(allLogs);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ copyAllLogs: ', error);
                alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
            }
        }
        
        function fallbackCopy(text) {
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π textarea
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    throw new Error('execCommand failed');
                }
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        function resetUser1() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (user1.peerConnection) {
                user1.peerConnection.close();
                user1.peerConnection = null;
            }
            
            // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ
            const remoteVideo = document.getElementById('remoteVideo1');
            remoteVideo.srcObject = null;
            
            user1.state = 'idle';
            user1.targetUser = null;
            user1.log(`üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ: ${user1.state}`, 'warning');
            updateCallButtons(user1);
        }
        
        function resetUser2() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (user2.peerConnection) {
                user2.peerConnection.close();
                user2.peerConnection = null;
            }
            
            // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ
            const remoteVideo = document.getElementById('remoteVideo2');
            remoteVideo.srcObject = null;
            
            user2.state = 'idle';
            user2.targetUser = null;
            user2.log(`üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ: ${user2.state}`, 'warning');
            updateCallButtons(user2);
        }
        
        // WebRTC —Ñ—É–Ω–∫—Ü–∏–∏
        async function initWebRTC(user) {
            try {
                user.log(`üé• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC –¥–ª—è ${user.id}`, 'info');
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫
                try {
                    user.localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    user.log(`‚úÖ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω (–≤–∏–¥–µ–æ + –∞—É–¥–∏–æ)`, 'success');
                } catch (videoError) {
                    user.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ: ${videoError.message}`, 'warning');
                    // –ü—Ä–æ–±—É–µ–º —Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ
                    try {
                        user.localStream = await navigator.mediaDevices.getUserMedia({
                            video: false,
                            audio: true
                        });
                        user.log(`‚úÖ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω (—Ç–æ–ª—å–∫–æ –∞—É–¥–∏–æ)`, 'success');
                    } catch (audioError) {
                        user.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞—É–¥–∏–æ: ${audioError.message}`, 'error');
                        throw audioError;
                    }
                }
                
                const videoId = user.id === 'user1' ? 'localVideo1' : 'localVideo2';
                const localVideo = document.getElementById(videoId);
                localVideo.srcObject = user.localStream;
                
                updateCallButtons(user);
                
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
                user.log(`üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É/–º–∏–∫—Ä–æ—Ñ–æ–Ω`, 'info');
            }
        }
        
        function updateCallButtons(user) {
            if (user.id === 'user1') {
                const offerBtn = document.getElementById('offerBtn1');
                const disconnectBtn = document.getElementById('disconnectBtn1');
                if (user.state === 'connected') {
                    offerBtn.style.display = 'inline-block';
                    offerBtn.disabled = false;
                    disconnectBtn.style.display = 'inline-block';
                    disconnectBtn.disabled = false;
                } else {
                    offerBtn.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                }
            } else if (user.id === 'user2') {
                const autoAnswerInfo = document.getElementById('autoAnswerInfo');
                if (user.state === 'connected') {
                    autoAnswerInfo.style.display = 'block';
                } else {
                    autoAnswerInfo.style.display = 'none';
                }
            }
        }
        
        // –¢–µ—Å—Ç offer
        async function testOffer1() {
            if (user1.state !== 'connected') {
                user1.log('‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ offer', 'warning');
                return;
            }

            try {
                user1.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ offer –∫ user2`, 'warning');
                
                const testOffer = {
                    type: 'offer',
                    sdp: 'v=0\r\no=- 1234567890 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0\r\nm=audio 9 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:test\r\na=ice-pwd:test\r\na=fingerprint:sha-256 test\r\na=setup:actpass\r\na=mid:0\r\na=sendrecv\r\na=rtpmap:111 opus/48000/2\r\n'
                };

                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: user1.id,
                        to: 'user2',
                        type: 'offer',
                        data: testOffer
                    })
                });

                const result = await response.json();
                if (result.success) {
                    user1.log(`‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                } else {
                    user1.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ offer: ${result.error}`, 'error');
                }
            } catch (error) {
                user1.log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ answer
        async function sendTestAnswer(user, toUserId) {
            const startTime = Date.now();
            try {
                user.log(`üì§ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ answer –∫ ${toUserId}`, 'warning');
                
                const testAnswer = {
                    type: 'answer',
                    sdp: 'v=0\r\no=- 1234567890 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0\r\nm=audio 9 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:test\r\na=ice-pwd:test\r\na=fingerprint:sha-256 test\r\na=setup:active\r\na=mid:0\r\na=sendrecv\r\na=rtpmap:111 opus/48000/2\r\n'
                };

                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: user.id,
                        to: toUserId,
                        type: 'answer',
                        data: testAnswer
                    })
                });

                const result = await response.json();
                const sendTime = Date.now() - startTime;
                if (result.success) {
                    user.log(`‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ (${sendTime}–º—Å)`, 'success');
                } else {
                    user.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ answer: ${result.error}`, 'error');
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –¢–µ—Å—Ç answer (—Ä—É—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞)
        async function testAnswer2() {
            await sendTestAnswer(user2, 'user1');
        }

        // –†–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function disconnectCall() {
            if (user1.state !== 'connected') {
                user1.log('‚ö†Ô∏è –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑—Ä—ã–≤–∞', 'warning');
                return;
            }

            try {
                user1.log(`üîå –†–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${user1.targetUser}`, 'warning');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª disconnect –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                await sendSignal(user1, user1.targetUser, 'disconnect', { reason: 'user_disconnect' });
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ User 1
                user1.state = 'idle';
                user1.targetUser = null;
                user1.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user1.state}`, 'info');
                user1.log(`üîÑ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ, –≤–æ–∑–≤—Ä–∞—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                updateCallButtons(user1);
                
            } catch (error) {
                user1.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }
        
        
        
        
        
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ WebRTC —Å–∏–≥–Ω–∞–ª–æ–≤
        async function handleOffer(user, signal) {
            if (user.state !== 'connected') {
                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º offer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'warning');
                return;
            }

            user.log(`üì• –ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${signal.from}`, 'warning');
            user.log(`üì• Offer –¥–∞–Ω–Ω—ã–µ: type=${signal.data.type}, sdp –¥–ª–∏–Ω–∞=${signal.data.sdp ? signal.data.sdp.length : 'undefined'}`, 'info');
            user.log(`üì• –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${user.state}`, 'info');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
            await sendTestAnswer(user, signal.from);
        }
        
        function handleAnswer(user, signal) {
            if (user.state !== 'connected') {
                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º answer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'warning');
                return;
            }

            user.log(`üì• –ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${signal.from}`, 'warning');
            user.log(`üì• Answer –¥–∞–Ω–Ω—ã–µ: type=${signal.data.type}, sdp –¥–ª–∏–Ω–∞=${signal.data.sdp ? signal.data.sdp.length : 'undefined'}`, 'info');
            user.log(`‚úÖ Offer/Answer –æ–±–º–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!`, 'success');
        }
        
        function handleIceCandidate(user, signal) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –≤ –ø—Ä–æ—Å—Ç–æ–º —Ç–µ—Å—Ç–µ
            user.log(`üßä –ü–æ–ª—É—á–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç ${signal.from} (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º)`, 'info');
        }

        function handleDisconnect(user, signal) {
            if (user.state === 'connected' && user.targetUser === signal.from) {
                user.log(`üîå –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª —Ä–∞–∑—Ä—ã–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç ${signal.from}`, 'warning');
                user.log(`üìä –ü—Ä–∏—á–∏–Ω–∞: ${signal.data.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`, 'info');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user.state = 'idle';
                user.targetUser = null;
                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'info');
                user.log(`üîÑ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ, –≤–æ–∑–≤—Ä–∞—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                updateCallButtons(user);
            } else {
                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º disconnect –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}, –æ–∂–∏–¥–∞–ª–∏: ${user.targetUser}`, 'warning');
            }
        }
        
        function showCopySuccess() {
            const button = document.querySelector('button[onclick="copyAllLogs()"]');
            const originalText = button.textContent;
            button.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            button.style.background = '#45a049';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#4CAF50';
            }, 2000);
            
            console.log('–õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
        }
    </script>
</body>
</html>