<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC –¢–µ—Å—Ç –ó–≤–æ–Ω–∫–æ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .video-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .video-wrapper {
            flex: 1;
            text-align: center;
        }

        video {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            background: #000;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            margin: 0 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
        }

        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }

        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .connection-status.connected {
            background-color: #28a745;
            color: white;
        }

        .connection-status.connecting {
            background-color: #ffc107;
            color: black;
        }

        .connection-status.disconnected {
            background-color: #dc3545;
            color: white;
        }

        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîä WebRTC –¢–µ—Å—Ç –ó–≤–æ–Ω–∫–æ–≤</h1>
        
        <div class="status disconnected" id="connectionStatus">
            –°—Ç–∞—Ç—É—Å: –û—Ç–∫–ª—é—á–µ–Ω
        </div>

        <div class="form-group">
            <label for="userId">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
            <input type="text" id="userId" value="user1" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="initWebRTC()">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å WebRTC</button>
            <button class="btn btn-success" onclick="startCall()" id="startCallBtn" disabled>–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button class="btn btn-danger" onclick="endCall()" id="endCallBtn" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
        </div>

        <div class="video-container">
            <div class="video-wrapper">
                <h3>–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ</h3>
                <video id="localVideo" autoplay muted></video>
            </div>
            <div class="video-wrapper">
                <h3>–£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ</h3>
                <video id="remoteVideo" autoplay></video>
            </div>
        </div>

        <div class="log" id="log">
            <div>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</div>
        </div>
    </div>

    <script>
        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { 
                    urls: 'turn:62.84.126.200:3478', 
                    username: 'webrtc', 
                    credential: 'password123' 
                },
                { 
                    urls: 'turns:62.84.126.200:3479', 
                    username: 'webrtc', 
                    credential: 'password123' 
                }
            ]
        };

        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentUserId = null;
        let isConnected = false;

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message) {
            const logElement = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${time}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `status ${status}`;
            statusElement.textContent = `–°—Ç–∞—Ç—É—Å: ${status === 'connected' ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : 
                                                      status === 'connecting' ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...' : '–û—Ç–∫–ª—é—á–µ–Ω'}`;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC
        async function initWebRTC() {
            try {
                currentUserId = document.getElementById('userId').value;
                if (!currentUserId) {
                    alert('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }

                log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebRTC...');
                updateStatus('connecting');

                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;
                log('–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω');

                // –°–æ–∑–¥–∞–µ–º peer connection
                peerConnection = new RTCPeerConnection(configuration);
                log('Peer connection —Å–æ–∑–¥–∞–Ω');

                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç: ' + event.candidate.candidate);
                    }
                };

                peerConnection.ontrack = (event) => {
                    log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫');
                    remoteStream = event.streams[0];
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                };

                peerConnection.onconnectionstatechange = () => {
                    log('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + peerConnection.connectionState);
                    if (peerConnection.connectionState === 'connected') {
                        isConnected = true;
                        updateStatus('connected');
                        document.getElementById('startCallBtn').disabled = true;
                        document.getElementById('endCallBtn').disabled = false;
                    } else if (peerConnection.connectionState === 'disconnected') {
                        isConnected = false;
                        updateStatus('disconnected');
                        document.getElementById('startCallBtn').disabled = false;
                        document.getElementById('endCallBtn').disabled = true;
                    }
                };

                updateStatus('connected');
                document.getElementById('startCallBtn').disabled = false;
                log('WebRTC –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');

            } catch (error) {
                log('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
                updateStatus('disconnected');
            }
        }

        // –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
        async function startCall() {
            try {
                log('–ù–∞—á–∏–Ω–∞–µ–º –∑–≤–æ–Ω–æ–∫...');
                
                // –°–æ–∑–¥–∞–µ–º offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                log('Offer —Å–æ–∑–¥–∞–Ω: ' + offer.type);
                
                // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∏–≥–Ω–∞–ª–∏–Ω–≥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ offer –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
                log('Offer –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä');
                
            } catch (error) {
                log('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞: ' + error.message);
            }
        }

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        function endCall() {
            try {
                log('–ó–∞–≤–µ—Ä—à–∞–µ–º –∑–≤–æ–Ω–æ–∫...');
                
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                document.getElementById('localVideo').srcObject = null;
                document.getElementById('remoteVideo').srcObject = null;
                
                isConnected = false;
                updateStatus('disconnected');
                document.getElementById('startCallBtn').disabled = false;
                document.getElementById('endCallBtn').disabled = true;
                
                log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
                
            } catch (error) {
                log('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞: ' + error.message);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            log('WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
        } else {
            log('WebRTC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        }
    </script>
</body>
</html>
