<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC –ü—Ä–æ—Å—Ç–æ–π –¢–µ—Å—Ç</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .test-section h3 {
            color: #007bff;
            margin-bottom: 15px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.danger {
            background: #dc3545;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .video-box {
            text-align: center;
        }
        
        .video-box video {
            width: 100%;
            max-width: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ WebRTC –ü—Ä–æ—Å—Ç–æ–π –¢–µ—Å—Ç</h1>
        
        <!-- –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC -->
        <div class="test-section">
            <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC</h3>
            <button class="btn" onclick="checkWebRTCSupport()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
            <div id="webrtcStatus" class="status" style="display: none;"></div>
        </div>
        
        <!-- –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–æ–≤ -->
        <div class="test-section">
            <h3>2. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–æ–≤</h3>
            <button class="btn" onclick="getUserMedia()">–ü–æ–ª—É—á–∏—Ç—å –∫–∞–º–µ—Ä—É/–º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
            <button class="btn danger" onclick="stopUserMedia()">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <div id="mediaStatus" class="status" style="display: none;"></div>
            <div class="video-container">
                <div class="video-box">
                    <h4>–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ</h4>
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
            </div>
        </div>
        
        <!-- –¢–µ—Å—Ç 3: Peer Connection -->
        <div class="test-section">
            <h3>3. –°–æ–∑–¥–∞–Ω–∏–µ Peer Connection</h3>
            <button class="btn" onclick="createPeerConnection()">–°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
            <button class="btn danger" onclick="closePeerConnection()">–ó–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
            <div id="peerStatus" class="status" style="display: none;"></div>
        </div>
        
        <!-- –¢–µ—Å—Ç 4: –°–∏–≥–Ω–∞–ª–∏–Ω–≥ -->
        <div class="test-section">
            <h3>4. –¢–µ—Å—Ç —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞</h3>
            <div class="input-group">
                <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="userId" value="test_user_1" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            </div>
            <button class="btn" onclick="testSignaling()">–¢–µ—Å—Ç —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞</button>
            <button class="btn" onclick="sendTestSignal()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª</button>
            <div id="signalingStatus" class="status" style="display: none;"></div>
        </div>

        <!-- –¢–µ—Å—Ç 5: –ü–æ–ª–Ω—ã–π WebRTC —Ç–µ—Å—Ç -->
        <div class="test-section">
            <h3>5. –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç WebRTC (–≤—Å–µ —Å—Ç–∞–¥–∏–∏)</h3>
            <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.</p>
            
            <div style="display: flex; gap: 20px; margin: 20px 0;">
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                    <h4>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1</h4>
                    <input type="text" id="user1Id" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1" value="user1" style="width: 100%; margin-bottom: 10px;">
                    <button class="btn" onclick="startUser1()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å User 1</button>
                    <button class="btn" onclick="sendPing1()" id="pingBtn1" disabled>üì° Ping –∫ User 2</button>
                    <button class="btn" onclick="testOffer1()" id="offerBtn1" disabled style="background: #2196F3;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å Offer</button>
                    <button class="btn" onclick="disconnectCall1()" id="disconnectBtn1" disabled style="background: #f44336;">üîå –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                    <div id="user1Status" class="status" style="display: none; margin-top: 10px;"></div>
                </div>
                
                <div style="flex: 1; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                    <h4>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2</h4>
                    <input type="text" id="user2Id" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2" value="user2" style="width: 100%; margin-bottom: 10px;">
                    <button class="btn" onclick="startUser2()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å User 2</button>
                    <button class="btn" onclick="sendPing2()" id="pingBtn2" disabled>üì° Ping –∫ User 1</button>
                    <button class="btn" onclick="testAnswer2()" id="answerBtn2" disabled style="background: #4CAF50;">üì• –û—Ç–ø—Ä–∞–≤–∏—Ç—å Answer</button>
                    <button class="btn" onclick="disconnectCall2()" id="disconnectBtn2" disabled style="background: #f44336;">üîå –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                    <div id="user2Status" class="status" style="display: none; margin-top: 10px;"></div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin: 20px 0;">
                <div style="flex: 1;">
                    <h4>üìπ –í–∏–¥–µ–æ User 1</h4>
                    <video id="localVideo1" autoplay muted style="width: 100%; max-width: 300px; height: 200px; border: 2px solid #4CAF50; background: #000;"></video>
                    <video id="remoteVideo1" autoplay style="width: 100%; max-width: 300px; height: 200px; border: 2px solid #2196F3; background: #000;"></video>
                </div>
                <div style="flex: 1;">
                    <h4>üìπ –í–∏–¥–µ–æ User 2</h4>
                    <video id="localVideo2" autoplay muted style="width: 100%; max-width: 300px; height: 200px; border: 2px solid #4CAF50; background: #000;"></video>
                    <video id="remoteVideo2" autoplay style="width: 100%; max-width: 300px; height: 200px; border: 2px solid #2196F3; background: #000;"></video>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn" onclick="copyAllLogs()" style="background: #4CAF50;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ª–æ–≥–∏</button>
                <button class="btn" onclick="resetAllUsers()" style="background: #ff9800;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ</button>
            </div>
        </div>
        
        <!-- –õ–æ–≥ -->
        <div class="test-section">
            <h3>üìù –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h3>
            <button class="btn" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let localStream = null;
        let peerConnection = null;
        let currentUserId = null;
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìù';
            logElement.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
        }
        
        // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC
        function checkWebRTCSupport() {
            log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC...');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('webrtcStatus', 'WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                log('WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
                return false;
            }
            
            if (!window.RTCPeerConnection) {
                showStatus('webrtcStatus', 'RTCPeerConnection –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                log('RTCPeerConnection –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                return false;
            }
            
            showStatus('webrtcStatus', 'WebRTC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
            log('WebRTC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'success');
            return true;
        }
        
        // –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–æ–≤
        async function getUserMedia() {
            try {
                log('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                
                showStatus('mediaStatus', '–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                log('–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                log(`–í–∏–¥–µ–æ —Ç—Ä–µ–∫–æ–≤: ${localStream.getVideoTracks().length}`, 'info');
                log(`–ê—É–¥–∏–æ —Ç—Ä–µ–∫–æ–≤: ${localStream.getAudioTracks().length}`, 'info');
                
            } catch (error) {
                showStatus('mediaStatus', `–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
            }
        }
        
        function stopUserMedia() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = null;
                
                showStatus('mediaStatus', '–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'info');
                log('–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'info');
            }
        }
        
        // –¢–µ—Å—Ç 3: –°–æ–∑–¥–∞–Ω–∏–µ Peer Connection
        function createPeerConnection() {
            try {
                log('–°–æ–∑–¥–∞–Ω–∏–µ Peer Connection...');
                
                const configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { 
                            urls: 'turn:62.84.126.200:3478', 
                            username: 'webrtc', 
                            credential: 'password123' 
                        }
                    ]
                };
                
                peerConnection = new RTCPeerConnection(configuration);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        log('ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –ø–æ–ª—É—á–µ–Ω', 'info');
                    }
                };
                
                peerConnection.ontrack = (event) => {
                    log('–£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω', 'success');
                    const remoteVideo = document.getElementById('remoteVideo');
                    if (remoteVideo) {
                        remoteVideo.srcObject = event.streams[0];
                    }
                };
                
                peerConnection.onconnectionstatechange = () => {
                    log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${peerConnection.connectionState}`, 'info');
                };
                
                peerConnection.oniceconnectionstatechange = () => {
                    log(`ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${peerConnection.iceConnectionState}`, 'info');
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });
                    log('–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ Peer Connection', 'success');
                }
                
                showStatus('peerStatus', 'Peer Connection —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                log('Peer Connection —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                
            } catch (error) {
                showStatus('peerStatus', `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Peer Connection: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Peer Connection: ${error.message}`, 'error');
            }
        }
        
        function closePeerConnection() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
                showStatus('peerStatus', 'Peer Connection –∑–∞–∫—Ä—ã—Ç', 'info');
                log('Peer Connection –∑–∞–∫—Ä—ã—Ç', 'info');
            }
        }
        
        // –¢–µ—Å—Ç 4: –°–∏–≥–Ω–∞–ª–∏–Ω–≥
        function testSignaling() {
            currentUserId = document.getElementById('userId').value;
            if (!currentUserId) {
                showStatus('signalingStatus', '–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            log(`–¢–µ—Å—Ç —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${currentUserId}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞
            const signalingUrl = 'https://lizamsg.ru:3000/api/signaling';
            
            fetch(signalingUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'ping',
                    from: currentUserId,
                    to: 'test_user_2'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('signalingStatus', '–°–∏–≥–Ω–∞–ª–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                    log('–°–∏–≥–Ω–∞–ª–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                } else {
                    showStatus('signalingStatus', '–°–∏–≥–Ω–∞–ª–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                    log('–°–∏–≥–Ω–∞–ª–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                }
            })
            .catch(error => {
                showStatus('signalingStatus', `–û—à–∏–±–∫–∞ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞: ${error.message}`, 'error');
            });
        }
        
        function sendTestSignal() {
            if (!currentUserId) {
                showStatus('signalingStatus', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞', 'error');
                return;
            }
            
            log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞...');
            
            const signalingUrl = 'https://lizamsg.ru:3000/api/signaling';
            
            fetch(signalingUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'signal',
                    from: currentUserId,
                    to: 'test_user_2',
                    type: 'test',
                    data: { message: '–¢–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª' }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('signalingStatus', '–¢–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                    log('–¢–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                } else {
                    showStatus('signalingStatus', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞', 'error');
                    log('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞', 'error');
                }
            })
            .catch(error => {
                showStatus('signalingStatus', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
                log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞: ${error.message}`, 'error');
            });
        }
        
        // ===== –ü–û–õ–ù–´–ô WEBRTC –¢–ï–°–¢ =====
        
        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { 
                    urls: 'turn:62.84.126.200:3478',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                },
                { 
                    urls: 'turns:62.84.126.200:3479',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                }
            ]
        };
        
        // –û–±—ä–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
        let user1 = {
            id: 'user1',
            lastSignalId: 0,
            interval: null,
            state: 'idle', // idle, connecting, connected, calling
            targetUser: null,
            peerConnection: null,
            localStream: null,
            log: (msg, type = 'info') => {
                const time = new Date().toLocaleTimeString();
                log(`[User1] ${msg}`, type);
            }
        };
        
        let user2 = {
            id: 'user2',
            lastSignalId: 0,
            interval: null,
            state: 'idle',
            targetUser: null,
            peerConnection: null,
            localStream: null,
            log: (msg, type = 'info') => {
                const time = new Date().toLocaleTimeString();
                log(`[User2] ${msg}`, type);
            }
        };
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è User 1
        async function startUser1() {
            user1.id = document.getElementById('user1Id').value;
            if (!user1.id) {
                showStatus('user1Status', '–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1', 'error');
                return;
            }
            
            user1.log('–ó–∞–ø—É—Å–∫ User 1...', 'info');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                user1.localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('localVideo1').srcObject = user1.localStream;
                user1.log('–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã', 'success');
                
                // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('pingBtn1').disabled = false;
                showStatus('user1Status', 'User 1 –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
                
            } catch (error) {
                user1.log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
                showStatus('user1Status', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function sendPing1() {
            if (user1.state !== 'idle') {
                user1.log('–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ping - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ', 'warning');
                return;
            }
            
            user1.state = 'connecting';
            user1.targetUser = user2.id;
            user1.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ ping –∫ ${user2.id}`, 'info');
            
            try {
                const response = await fetch('https://lizamsg.ru:3000/api/signaling', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'ping',
                        from: user1.id,
                        to: user2.id,
                        data: { timestamp: Date.now() }
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    user1.log('Ping –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                    document.getElementById('offerBtn1').disabled = false;
                } else {
                    user1.log('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping', 'error');
                    user1.state = 'idle';
                }
            } catch (error) {
                user1.log(`–û—à–∏–±–∫–∞ ping: ${error.message}`, 'error');
                user1.state = 'idle';
            }
        }
        
        async function testOffer1() {
            if (user1.state !== 'connecting') {
                user1.log('–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º offer - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ', 'warning');
                return;
            }
            
            user1.log('–°–æ–∑–¥–∞–Ω–∏–µ Peer Connection...', 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º Peer Connection
                user1.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                user1.localStream.getTracks().forEach(track => {
                    user1.peerConnection.addTrack(track, user1.localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                user1.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        sendSignal(user1.id, user2.id, 'ice-candidate', event.candidate);
                    }
                };
                
                user1.peerConnection.ontrack = (event) => {
                    user1.log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    document.getElementById('remoteVideo1').srcObject = event.streams[0];
                };
                
                // –°–æ–∑–¥–∞–µ–º offer
                const offer = await user1.peerConnection.createOffer();
                await user1.peerConnection.setLocalDescription(offer);
                
                user1.log('Offer —Å–æ–∑–¥–∞–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞...', 'info');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
                await sendSignal(user1.id, user2.id, 'offer', offer);
                
                user1.state = 'calling';
                document.getElementById('disconnectBtn1').disabled = false;
                user1.log('Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ answer', 'success');
                
            } catch (error) {
                user1.log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ${error.message}`, 'error');
                user1.state = 'idle';
            }
        }
        
        function disconnectCall1() {
            if (user1.peerConnection) {
                user1.peerConnection.close();
                user1.peerConnection = null;
            }
            
            if (user1.localStream) {
                user1.localStream.getTracks().forEach(track => track.stop());
            }
            
            user1.state = 'idle';
            user1.targetUser = null;
            
            document.getElementById('offerBtn1').disabled = true;
            document.getElementById('disconnectBtn1').disabled = true;
            
            user1.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'warning');
            showStatus('user1Status', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'warning');
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è User 2
        async function startUser2() {
            user2.id = document.getElementById('user2Id').value;
            if (!user2.id) {
                showStatus('user2Status', '–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2', 'error');
                return;
            }
            
            user2.log('–ó–∞–ø—É—Å–∫ User 2...', 'info');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                user2.localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('localVideo2').srcObject = user2.localStream;
                user2.log('–ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã', 'success');
                
                // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('pingBtn2').disabled = false;
                showStatus('user2Status', 'User 2 –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
                
            } catch (error) {
                user2.log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
                showStatus('user2Status', `–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function sendPing2() {
            if (user2.state !== 'idle') {
                user2.log('–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ping - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ', 'warning');
                return;
            }
            
            user2.state = 'connecting';
            user2.targetUser = user1.id;
            user2.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ ping –∫ ${user1.id}`, 'info');
            
            try {
                const response = await fetch('https://lizamsg.ru:3000/api/signaling', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'ping',
                        from: user2.id,
                        to: user1.id,
                        data: { timestamp: Date.now() }
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    user2.log('Ping –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                    document.getElementById('answerBtn2').disabled = false;
                } else {
                    user2.log('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping', 'error');
                    user2.state = 'idle';
                }
            } catch (error) {
                user2.log(`–û—à–∏–±–∫–∞ ping: ${error.message}`, 'error');
                user2.state = 'idle';
            }
        }
        
        async function testAnswer2() {
            if (user2.state !== 'connecting') {
                user2.log('–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º answer - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ', 'warning');
                return;
            }
            
            user2.log('–°–æ–∑–¥–∞–Ω–∏–µ Peer Connection...', 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º Peer Connection
                user2.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                user2.localStream.getTracks().forEach(track => {
                    user2.peerConnection.addTrack(track, user2.localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                user2.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        sendSignal(user2.id, user1.id, 'ice-candidate', event.candidate);
                    }
                };
                
                user2.peerConnection.ontrack = (event) => {
                    user2.log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    document.getElementById('remoteVideo2').srcObject = event.streams[0];
                };
                
                // –°–æ–∑–¥–∞–µ–º answer
                const answer = await user2.peerConnection.createAnswer();
                await user2.peerConnection.setLocalDescription(answer);
                
                user2.log('Answer —Å–æ–∑–¥–∞–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞...', 'info');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                await sendSignal(user2.id, user1.id, 'answer', answer);
                
                user2.state = 'calling';
                document.getElementById('disconnectBtn2').disabled = false;
                user2.log('Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                
            } catch (error) {
                user2.log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è answer: ${error.message}`, 'error');
                user2.state = 'idle';
            }
        }
        
        function disconnectCall2() {
            if (user2.peerConnection) {
                user2.peerConnection.close();
                user2.peerConnection = null;
            }
            
            if (user2.localStream) {
                user2.localStream.getTracks().forEach(track => track.stop());
            }
            
            user2.state = 'idle';
            user2.targetUser = null;
            
            document.getElementById('answerBtn2').disabled = true;
            document.getElementById('disconnectBtn2').disabled = true;
            
            user2.log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'warning');
            showStatus('user2Status', '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'warning');
        }
        
        // –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
        async function sendSignal(from, to, type, data) {
            try {
                const response = await fetch('https://lizamsg.ru:3000/api/signaling', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: from,
                        to: to,
                        type: type,
                        data: data
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`–°–∏–≥–Ω–∞–ª ${type} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç ${from} –∫ ${to}`, 'success');
                } else {
                    log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ ${type}`, 'error');
                }
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞: ${error.message}`, 'error');
            }
        }
        
        function copyAllLogs() {
            const logContent = document.getElementById('log').innerText;
            navigator.clipboard.writeText(logContent).then(() => {
                log('–õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            });
        }
        
        function resetAllUsers() {
            disconnectCall1();
            disconnectCall2();
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π
            user1.state = 'idle';
            user2.state = 'idle';
            
            // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫
            document.getElementById('pingBtn1').disabled = true;
            document.getElementById('offerBtn1').disabled = true;
            document.getElementById('disconnectBtn1').disabled = true;
            document.getElementById('pingBtn2').disabled = true;
            document.getElementById('answerBtn2').disabled = true;
            document.getElementById('disconnectBtn2').disabled = true;
            
            // –û—á–∏—Å—Ç–∫–∞ –≤–∏–¥–µ–æ
            document.getElementById('localVideo1').srcObject = null;
            document.getElementById('remoteVideo1').srcObject = null;
            document.getElementById('localVideo2').srcObject = null;
            document.getElementById('remoteVideo2').srcObject = null;
            
            log('–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–±—Ä–æ—à–µ–Ω—ã', 'info');
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...');
            checkWebRTCSupport();
        };
    </script>
</body>
</html>
