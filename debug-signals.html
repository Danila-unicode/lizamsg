<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Signal Delivery</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .log { border: 1px solid #ddd; padding: 10px; margin-top: 10px; height: 400px; overflow-y: scroll; background-color: #f9f9f9; font-family: monospace; font-size: 12px; }
        .log-entry { margin-bottom: 5px; padding: 3px; border-radius: 3px; }
        .log-entry.info { color: #0056b3; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.error { color: #dc3545; }
        .log-entry.success { color: #28a745; }
        input[type="text"], button { padding: 10px; margin-right: 10px; border-radius: 5px; border: 1px solid #ddd; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Signal Delivery</h1>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.</p>
        
        <div>
            <label for="userIdInput">–í–∞—à User ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, user1 –∏–ª–∏ user12):</label>
            <input type="text" id="userIdInput" value="user1">
            <button onclick="startDebug()">–ù–∞—á–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É</button>
            <button onclick="sendTestPing()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π ping</button>
        </div>
        
        <div>
            <label for="targetUserIdInput">–¶–µ–ª–µ–≤–æ–π User ID –¥–ª—è ping:</label>
            <input type="text" id="targetUserIdInput" value="user12">
        </div>
        
        <div class="log" id="log">
            <div class="log-entry info">[–°–∏—Å—Ç–µ–º–∞] –ì–æ—Ç–æ–≤ –∫ –æ—Ç–ª–∞–¥–∫–µ —Å–∏–≥–Ω–∞–ª–æ–≤.</div>
        </div>
    </div>

    <script>
        const SIGNALING_SERVER = 'https://lizamsg.ru:3000/api/signaling';
        // const SIGNALING_SERVER = 'api/signaling_server.php'; // –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let lastSignalId = 0;
        let signalCheckInterval = null;
        let currentUserId = null;
        let processedSignals = new Set();
        let sentSignals = new Set();
        let pendingPings = new Map(); // –•—Ä–∞–Ω–∏–º –æ–∂–∏–¥–∞—é—â–∏–µ pong'–∏
        let signalCounter = 0; // –°—á–µ—Ç—á–∏–∫ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID —Å–∏–≥–Ω–∞–ª–æ–≤

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function generateSignalId() {
            signalCounter++;
            return `signal_${Date.now()}_${signalCounter}_${currentUserId}`;
        }

        async function sendSignal(to, type, data) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ –º—ã —É–∂–µ —Ç–∞–∫–æ–π —Å–∏–≥–Ω–∞–ª –Ω–µ–¥–∞–≤–Ω–æ
                const sendKey = `send_${type}_${to}_${JSON.stringify(data).substring(0, 50)}`;
                
                if (sentSignals.has(sendKey)) {
                    log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Å–∏–≥–Ω–∞–ª–∞: ${type} –∫ ${to}`, 'warning');
                    return true; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true, —Ç–∞–∫ –∫–∞–∫ —Å–∏–≥–Ω–∞–ª —É–∂–µ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
                }
                
                sentSignals.add(sendKey);
                log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞: ${type} –æ—Ç ${currentUserId} –∫ ${to}`, 'info');
                
                const signalData = {
                    action: 'signal',
                    from: currentUserId,
                    to: to,
                    type: type,
                    data: data
                };
                
                log(`üì§ –î–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª–∞: ${JSON.stringify(signalData)}`, 'info');
                
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(signalData)
                });
                
                const result = await response.json();
                log(`üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(result)}`, 'info');
                return result.success;
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkSignals() {
            if (!currentUserId) return;
            
            try {
                const url = `${SIGNALING_SERVER}?action=signals&userId=${currentUserId}&since=${lastSignalId}`;
                log(`üîç –ó–∞–ø—Ä–æ—Å —Å–∏–≥–Ω–∞–ª–æ–≤: ${url}`, 'info');
                const response = await fetch(url);
                const data = await response.json();
                
                log(`üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(data)}`, 'info');

                if (data.success && data.signals && data.signals.length > 0) {
                    log(`üì® –ü–æ–ª—É—á–µ–Ω–æ ${data.signals.length} —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã - –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–æ–≤–µ–µ lastSignalId
                    const newSignals = data.signals.filter(signal => {
                        const signalTimestamp = signal.timestamp || signal.id;
                        return signalTimestamp > lastSignalId;
                    });
                    
                    if (newSignals.length === 0) {
                        log(`üîç –í—Å–µ —Å–∏–≥–Ω–∞–ª—ã —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ #${Math.floor(Date.now() / 1000)})`, 'info');
                        // –û–±–Ω–æ–≤–ª—è–µ–º lastSignalId –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                        const maxTimestamp = Math.max(...data.signals.map(s => s.timestamp || s.id));
                        lastSignalId = Math.max(lastSignalId, maxTimestamp);
                        return;
                    }
                    
                    log(`üì® –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${newSignals.length} –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
                    
                    newSignals.forEach(signal => {
                        // –°–†–ê–ó–£ –æ–±–Ω–æ–≤–ª—è–µ–º lastSignalId –¥–ª—è —ç—Ç–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
                        lastSignalId = Math.max(lastSignalId, signal.timestamp || signal.id);
                        
                        log(`üì® –°–∏–≥–Ω–∞–ª: ${signal.type} –æ—Ç ${signal.from} –∫ ${signal.to}`, 'info');
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ—Ç —Å–∏–≥–Ω–∞–ª
                        const signalId = signal.data?.signalId || 'no_id';
                        const signalKey = `${signal.type}_${signal.from}_${signalId}`;
                        if (processedSignals.has(signalKey)) {
                            log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª: ${signal.type} –æ—Ç ${signal.from} (ID: ${signalId})`, 'warning');
                            return;
                        }
                        
                        processedSignals.add(signalKey);
                        log(`‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª: ${signal.type} –æ—Ç ${signal.from}`, 'success');
                        
                        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–∏–≥–Ω–∞–ª—ã, –µ—Å–ª–∏ –∏—Ö —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ (–±–æ–ª—å—à–µ 50)
                        if (processedSignals.size > 50) {
                            log('üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã (–±–æ–ª—å—à–µ 50)', 'info');
                            processedSignals.clear();
                        }
                        
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
                        if (signal.from === currentUserId) {
                            log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª: ${signal.type}`, 'warning');
                            return;
                        }
                        
                        if (signal.type === 'ping') {
                            const signalId = signal.data.signalId;
                            log(`üèì –ü–æ–ª—É—á–µ–Ω ping –æ—Ç ${signal.from} (ID: ${signalId}) - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º pong`, 'warning');
                            sendSignal(signal.from, 'pong', { 
                                from: currentUserId, 
                                timestamp: Date.now(),
                                signalId: signalId // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ—Ç –∂–µ ID –æ–±—Ä–∞—Ç–Ω–æ
                            });
                        } else if (signal.type === 'pong') {
                            const signalId = signal.data.signalId;
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–ª–∏ –ª–∏ –º—ã pong –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —ç—Ç–∏–º ID
                            if (pendingPings.has(signal.from)) {
                                const pingInfo = pendingPings.get(signal.from);
                                if (pingInfo.signalId === signalId) {
                                    clearTimeout(pingInfo.timeout);
                                    pendingPings.delete(signal.from);
                                    log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} (ID: ${signalId}) - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω!`, 'success');
                                } else {
                                    log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º ID (–æ–∂–∏–¥–∞–ª–∏: ${pingInfo.signalId}, –ø–æ–ª—É—á–∏–ª–∏: ${signalId})`, 'warning');
                                }
                            } else {
                                log(`üèì –ü–æ–ª—É—á–µ–Ω –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π pong –æ—Ç ${signal.from} (ID: ${signalId})`, 'info');
                            }
                        }
                    });
                } else {
                    log(`üîç –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ #${Math.floor(Date.now() / 1000)})`, 'info');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤: ${error.message}`, 'error');
            }
        }

        function startDebug() {
            const userIdInput = document.getElementById('userIdInput').value;
            if (!userIdInput) {
                log('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ User ID.', 'error');
                return;
            }
            
            currentUserId = userIdInput;
            lastSignalId = Math.floor(Date.now() / 1000); // –ù–∞—á–∏–Ω–∞–µ–º —Å —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –¥–ª—è Yandex Cloud
            processedSignals.clear();
            sentSignals.clear();
            pendingPings.clear();
            signalCounter = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤
            log(`üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ª–∞–¥–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${currentUserId}`, 'info');

            if (signalCheckInterval) {
                clearInterval(signalCheckInterval);
            }
            signalCheckInterval = setInterval(checkSignals, 2000);
            checkSignals();
        }

        function sendTestPing() {
            const targetUserId = document.getElementById('targetUserIdInput').value;
            if (!targetUserId || !currentUserId) {
                log('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ User ID –∏ —Ü–µ–ª–µ–≤–æ–π User ID.', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ –º—ã —É–∂–µ ping –∫ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            if (pendingPings.has(targetUserId)) {
                log(`‚ö†Ô∏è –£–∂–µ –æ–∂–∏–¥–∞–µ–º pong –æ—Ç ${targetUserId}`, 'warning');
                return;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —ç—Ç–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
            const signalId = generateSignalId();
            log(`üèì –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π ping –∫ ${targetUserId} (ID: ${signalId})`, 'warning');
            
            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –º—ã –æ–∂–∏–¥–∞–µ–º pong –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            pendingPings.set(targetUserId, {
                signalId: signalId,
                timestamp: Date.now(),
                timeout: setTimeout(() => {
                    log(`‚è∞ –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è pong –æ—Ç ${targetUserId} (ID: ${signalId}) - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–µ—Ç–∏`, 'error');
                    pendingPings.delete(targetUserId);
                }, 5000) // 5 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
            });
            
            sendSignal(targetUserId, 'ping', { 
                from: currentUserId,
                timestamp: Date.now(),
                signalId: signalId,
                test: true
            });
        }
    </script>
</body>
</html>
