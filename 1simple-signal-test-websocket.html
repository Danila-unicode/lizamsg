<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç —Å–∏–≥–Ω–∞–ª–æ–≤ WebSocket</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .user-section { border: 1px solid #ccc; padding: 20px; margin: 10px 0; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; }
        input { padding: 5px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –æ–±–º–µ–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞–º–∏ WebSocket</h1>
        <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.</p>
        <button onclick="window.open('register.php', '_blank')" style="background: #4CAF50; color: white; padding: 10px 20px; margin: 10px 0; border: none; border-radius: 5px; cursor: pointer;">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        
        <div class="user-section">
            <h2>User 1</h2>
            <input type="text" id="user1Id" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω">
            <input type="password" id="user1Password" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display: none;">
            <input type="text" id="user1Target" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
            <button onclick="showPasswordField('user1')">–í–æ–π—Ç–∏ –∫–∞–∫ User 1</button>
            <button onclick="sendPingToTarget('user1')" style="display: none;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å ping –∫ —Ü–µ–ª–µ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</button>
            <button onclick="resetUser1()" style="background: #ff9800; color: white; display: none;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
            
        <div style="margin: 10px 0;">
            <button onclick="startCall('user1')" id="startCallBtn1" disabled style="background: #4CAF50; color: white; display: none;">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
        <button onclick="resetBothUsers()" id="resetBtn1" style="background: #FF9800; color: white; display: none;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
            <button onclick="testOffer1()" id="offerBtn1" disabled style="background: #2196F3; color: white; display: none;">üìû –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button onclick="startP2PCall()" id="p2pBtn1" disabled style="background: #9C27B0; color: white; display: none;">üìû –°–≤—è–∑—å</button>
            <button onclick="disconnectCall()" id="disconnectBtn1" disabled style="background: #f44336; color: white; display: none;">üîå –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
        </div>
            
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <video id="localVideo1" autoplay muted style="width: 200px; height: 150px; border: 2px solid #4CAF50; background: #000;"></video>
                <video id="remoteVideo1" autoplay style="width: 200px; height: 150px; border: 2px solid #2196F3; background: #000;"></video>
            </div>
            
            <div id="log1" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>User 2</h2>
            <input type="text" id="user2Id" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ª–æ–≥–∏–Ω">
            <input type="password" id="user2Password" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display: none;">
            <input type="text" id="user2Target" value="" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
            <button onclick="showPasswordField('user2')">–í–æ–π—Ç–∏ –∫–∞–∫ User 2</button>
            <button onclick="sendPingToTarget('user2')" style="display: none;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å ping –∫ —Ü–µ–ª–µ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</button>
            <button onclick="resetUser2()" style="background: #ff9800; color: white; display: none;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
            
        <div style="margin: 10px 0;">
            <button onclick="startCall('user2')" id="startCallBtn2" disabled style="background: #4CAF50; color: white; display: none;">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            <button onclick="testOffer2()" id="offerBtn2" disabled style="background: #2196F3; color: white; display: none;">üì§ –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button onclick="startP2PCall()" id="p2pBtn2" disabled style="background: #9C27B0; color: white; display: none;">üìû –°–≤—è–∑—å</button>
            <button onclick="disconnectCall()" id="disconnectBtn2" disabled style="background: #f44336; color: white; display: none;">üîå –†–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
            <button onclick="testAnswer2()" id="answerBtn2" disabled style="background: #4CAF50; color: white; display: none;">üì• –¢–µ—Å—Ç Answer (—Ä—É—á–Ω–æ–π)</button>
            <div id="autoAnswerInfo" style="display: none; color: #4CAF50; font-weight: bold;">ü§ñ Answer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ offer</div>
        </div>
            
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <video id="localVideo2" autoplay muted style="width: 200px; height: 150px; border: 2px solid #4CAF50; background: #000;"></video>
                <video id="remoteVideo2" autoplay style="width: 200px; height: 150px; border: 2px solid #2196F3; background: #000;"></video>
            </div>
            
            <div id="log2" class="log"></div>
        </div>
        
        <div class="user-section">
            <h2>–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤</h2>
            <button onclick="copyAllLogs()" style="background: #4CAF50; color: white; font-weight: bold;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ª–æ–≥–∏</button>
            <p>–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Å–∫–æ–ø–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É</p>
        </div>
    </div>

    <script>
        console.log('Script started');
        const SIGNALING_SERVER = 'https://lizamsg.ru:3000/api/signaling';
        
        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { 
                    urls: 'turn:89.169.141.202:3478',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                },
                { 
                    urls: 'turns:62.84.126.200:3479',
                    username: 'lizaapp',
                    credential: 'lizaapp123'
                }
            ]
        };
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        let globalInitiator = null;
        let isResetting = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
        
        let user1 = {
            id: 'user1',
            lastSignalId: 0,
            interval: null,
            state: 'idle', // idle, connecting, connected, calling
            targetUser: null,
            peerConnection: null,
            localStream: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log1');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        let user2 = {
            id: 'user2',
            lastSignalId: 0,
            interval: null,
            state: 'idle',
            targetUser: null,
            peerConnection: null,
            localStream: null,
            log: (msg, type = 'info') => {
                const logEl = document.getElementById('log2');
                const time = new Date().toLocaleTimeString();
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
                logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            }
        };
        
        // ===== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
        console.log('Defining universal user functions');
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—è –ø–∞—Ä–æ–ª—è
        function showPasswordField(userNum) {
            const passwordField = document.getElementById(userNum + 'Password');
            const loginButton = event.target;
            
            if (passwordField.style.display === 'none') {
                passwordField.style.display = 'block';
                loginButton.textContent = '–í–æ–π—Ç–∏';
                loginButton.onclick = () => startUser(userNum === 'user1' ? user1 : user2, userNum + 'Id', 'localVideo' + userNum.slice(-1));
            }
        }
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function startUser(user, userId, videoElementId) {
            const username = document.getElementById(userId).value;
            const password = document.getElementById(userId.replace('Id', 'Password')).value;
            
            if (!username) {
                user.log(`‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω`, 'error');
                return;
            }
            
            if (!password) {
                user.log(`‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å`, 'error');
                return;
            }
            
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user.log(`üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username}...`, 'info');
            
            try {
                const response = await fetch('https://lizaapp.wg01.ru/api/login.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    user.id = username;
                    user.sessionToken = data.sessionToken;
                    user.log(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞`, 'success');
                } else {
                    user.log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${data.error}`, 'error');
                    return;
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º`, 'error');
                return;
            }
            
            user.lastSignalId = Math.floor(Date.now() / 1000) - 60; // –ü–æ–ª—É—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–Ω—É—Ç—É
            user.state = 'idle';
            user.targetUser = null;
            user.log(`üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.id} –≥–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫–∞–º`, 'success');
            user.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—à–µ: ${user.lastSignalId}`, 'info');
            user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'info');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                user.localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById(videoElementId).srcObject = user.localStream;
                user.log('‚úÖ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã', 'success');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º polling –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
                if (user.interval) clearInterval(user.interval);
                user.interval = setInterval(() => checkSignals(user), 3000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
                checkSignals(user);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                updateCallButtons(user);
                
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞: ${error.message}`, 'error');
            }
        }
        
        // ===== USER 1 –§–£–ù–ö–¶–ò–ò =====
        async function startUser1() {
            await startUser(user1, 'user1Id', 'localVideo1');
        }
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ ping
        async function sendPing(caller, target) {
            if (caller.state !== 'idle') {
                caller.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ping - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${caller.state}`, 'warning');
                return;
            }
            
            caller.state = 'connecting';
            caller.targetUser = target.id;
            globalInitiator = caller.id; // caller —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–º –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º
            caller.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${caller.state}`, 'info');
            caller.log(`üîç –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω globalInitiator: ${globalInitiator}`, 'info');
            caller.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ping –∫ ${target.id}`, 'warning');
            
            try {
                const pingData = {
                    action: 'ping',
                    from: caller.id,
                    to: target.id,
                    data: { timestamp: Date.now() }
                };
                caller.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(pingData)}`, 'info');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pingData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                caller.log(`üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    caller.log(`‚úÖ Ping –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è pong
                    setTimeout(() => checkSignals(caller), 100);
                    // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É offer –∑–¥–µ—Å—å - –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è pong
                } else {
                    caller.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping: ${result.message}`, 'error');
                    caller.state = 'idle';
                    caller.targetUser = null;
                    globalInitiator = null;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    caller.log(`‚ùå –¢–∞–π–º–∞—É—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ ping (10 —Å–µ–∫)`, 'error');
                } else {
                    caller.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping: ${error.message}`, 'error');
                }
                caller.state = 'idle';
                caller.targetUser = null;
                globalInitiator = null;
            }
        }
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ ping –∫ —Ü–µ–ª–µ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        async function sendPingToTarget(userId) {
            const user = userId === 'user1' ? user1 : user2;
            const targetId = document.getElementById(`${userId}Target`).value;
            
            if (!targetId) {
                user.log('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const target = { id: targetId };
            
            await sendPing(user, target);
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏)
        async function sendPing1() {
            await sendPing(user1, user2);
        }
        
        async function sendPing2() {
            await sendPing(user2, user1);
        }
        
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function startWebRTCCall(caller, target) {
            if (caller.state !== 'connected') {
                caller.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å offer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${caller.state}`, 'warning');
                return;
            }
            
            caller.log('üîß –°–æ–∑–¥–∞–Ω–∏–µ Peer Connection...', 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º Peer Connection
                caller.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                caller.localStream.getTracks().forEach(track => {
                    caller.peerConnection.addTrack(track, caller.localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                caller.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        caller.log('üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞–π–¥–µ–Ω', 'info');
                        sendSignal(caller, target.id, 'ice-candidate', event.candidate);
                    }
                };
                
                caller.peerConnection.ontrack = (event) => {
                    caller.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    const videoId = caller.id === 'user1' ? 'remoteVideo1' : 'remoteVideo2';
                    document.getElementById(videoId).srcObject = event.streams[0];
                };
                
                caller.peerConnection.onconnectionstatechange = () => {
                    caller.log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${caller.peerConnection.connectionState}`, 'info');
                    if (caller.peerConnection.connectionState === 'connected') {
                        caller.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                    } else if (caller.peerConnection.connectionState === 'failed') {
                        caller.log('‚ùå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å', 'error');
                    } else if (caller.peerConnection.connectionState === 'disconnected') {
                        if (!isResetting) {
                            caller.log('üîå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ onconnectionstatechange', 'warning');
                            isResetting = true;
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                            resetUser1();
                            resetUser2();
                            globalInitiator = null;
                            updateAllCallButtons();
                            isResetting = false;
                            caller.log('‚úÖ –°–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω —á–µ—Ä–µ–∑ onconnectionstatechange', 'success');
                            
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                            user1.log('üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ user1 —á–µ—Ä–µ–∑ onconnectionstatechange...', 'info');
                            user2.log('üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ user2 —á–µ—Ä–µ–∑ onconnectionstatechange...', 'info');
                            
                            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
                            setTimeout(() => {
                                startUser(user1, 'user1Id', 'localVideo1');
                                startUser(user2, 'user2Id', 'localVideo2');
                            }, 1000);
                        } else {
                            caller.log('üîå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ - —Å–±—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ disconnectCall', 'info');
                        }
                    }
                };
                
                // –°–æ–∑–¥–∞–µ–º offer
                const offer = await caller.peerConnection.createOffer();
                await caller.peerConnection.setLocalDescription(offer);
                
                caller.log('üì§ Offer —Å–æ–∑–¥–∞–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞...', 'info');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
                await sendSignal(caller, target.id, 'offer', offer);
                
                caller.state = 'calling';
                caller.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${caller.state}`, 'info');
                updateAllCallButtons();
                caller.log('‚úÖ Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ answer', 'success');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º polling –¥–ª—è WebRTC —Å–∏–≥–Ω–∞–ª–æ–≤ (answer)
                caller.interval = setInterval(() => checkWebRTCSignals(caller), 3000);
                caller.log(`üîÑ –ó–∞–ø—É—â–µ–Ω polling –¥–ª—è WebRTC —Å–∏–≥–Ω–∞–ª–æ–≤ (answer)`, 'info');
                
            } catch (error) {
                caller.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ${error.message}`, 'error');
                caller.state = 'idle';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏)
        async function testOffer1() {
            const targetId = document.getElementById('user1Target').value;
            if (!targetId) {
                user1.log('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'error');
                return;
            }
            const target = { id: targetId };
            await startWebRTCCall(user1, target);
        }
        
        async function testOffer2() {
            const targetId = document.getElementById('user2Target').value;
            if (!targetId) {
                user2.log('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'error');
                return;
            }
            const target = { id: targetId };
            await startWebRTCCall(user2, target);
        }
        
        
        // ===== USER 2 –§–£–ù–ö–¶–ò–ò =====
        async function startUser2() {
            await startUser(user2, 'user2Id', 'localVideo2');
        }
        
        
        async function testAnswer2() {
            if (user2.state !== 'connecting') {
                user2.log(`‚ö†Ô∏è –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å answer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user2.state}`, 'warning');
                return;
            }
            
            user2.log('üîß –°–æ–∑–¥–∞–Ω–∏–µ Peer Connection...', 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º Peer Connection
                user2.peerConnection = new RTCPeerConnection(rtcConfig);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                user2.localStream.getTracks().forEach(track => {
                    user2.peerConnection.addTrack(track, user2.localStream);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                user2.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        user2.log('üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞–π–¥–µ–Ω', 'info');
                        sendSignal(user2, user2.targetUser, 'ice-candidate', event.candidate);
                    }
                };
                
                user2.peerConnection.ontrack = (event) => {
                    user2.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                    document.getElementById('remoteVideo2').srcObject = event.streams[0];
                };
                
                // –°–æ–∑–¥–∞–µ–º answer
                const answer = await user2.peerConnection.createAnswer();
                await user2.peerConnection.setLocalDescription(answer);
                
                user2.log('üì• Answer —Å–æ–∑–¥–∞–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞...', 'info');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                await sendSignal(user2, user2.targetUser, 'answer', answer);
                
                user2.state = 'calling';
                user2.log('‚úÖ Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                
            } catch (error) {
                user2.log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è answer: ${error.message}`, 'error');
                user2.state = 'idle';
            }
        }
        
        // ===== –û–ë–©–ò–ï –§–£–ù–ö–¶–ò–ò =====
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∑–æ–≤–∞ (ping -> pong -> offer -> answer -> P2P)
        async function startCall(userId) {
            const user = userId === 'user1' ? user1 : user2;
            const targetId = document.getElementById(`${userId}Target`).value;
            
            if (!targetId) {
                user.log('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ idle
            if (user.state !== 'idle') {
                user.log(`‚ùå –ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –≤—ã–∑–æ–≤ - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}. –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–æ—Å—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.`, 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–∂–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ idle
            const targetUser = targetId === user1.id ? user1 : (targetId === user2.id ? user2 : null);
            if (targetUser && targetUser.state !== 'idle') {
                user.log(`‚ùå –ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –≤—ã–∑–æ–≤ - —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${targetId} –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏: ${targetUser.state}. –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–æ—Å—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.`, 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—â–µ–Ω (–µ—Å–ª–∏ —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
            if (targetUser && !targetUser.id) {
                user.log(`‚ùå –ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –≤—ã–∑–æ–≤ - —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${targetId} –Ω–µ –∑–∞–ø—É—â–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ.`, 'error');
                return;
            }
            
            user.log(`üìû –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—ã–π –≤—ã–∑–æ–≤ –∫ ${targetId}`, 'info');
            
            try {
                // –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping (–∫–∞–∫ –∫–Ω–æ–ø–∫–∞ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å ping –∫ —Ü–µ–ª–µ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é")
                user.log(`üì§ –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping –∫ ${targetId}`, 'info');
                await sendPingToTarget(userId);
                
                // –ñ–¥–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ping-pong —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                user.log(`‚è≥ –û–∂–∏–¥–∞–µ–º pong –æ—Ç ${targetId}...`, 'info');
                await waitForState(user, 'connected', 10000); // –ñ–¥–µ–º –¥–æ 10 —Å–µ–∫—É–Ω–¥
                
                // –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer (–∫–∞–∫ –∫–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫")
                user.log(`üì§ –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer –∫ ${targetId}`, 'info');
                const target = { id: targetId };
                await startWebRTCCall(user, target);
                
                // –ñ–¥–µ–º –ø–æ–ª—É—á–µ–Ω–∏—è answer –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user.log(`‚è≥ –û–∂–∏–¥–∞–µ–º answer –æ—Ç ${targetId}...`, 'info');
                await waitForAnswer(user, 10000); // –ñ–¥–µ–º –¥–æ 10 —Å–µ–∫—É–Ω–¥
                
                // –®–∞–≥ 3: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–∫–∞–∫ –∫–Ω–æ–ø–∫–∞ "–°–≤—è–∑—å")
                user.log(`üì§ –®–∞–≥ 3: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ`, 'info');
                await startP2PCall();
                
                user.log(`‚úÖ –ü–æ–ª–Ω—ã–π –≤—ã–∑–æ–≤ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!`, 'success');
                
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤—ã–∑–æ–≤–∞: ${error.message}`, 'error');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function waitForState(user, targetState, timeoutMs = 10000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                const checkState = () => {
                    if (user.state === targetState) {
                        user.log(`‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ: ${targetState}`, 'success');
                        resolve();
                    } else if (Date.now() - startTime > timeoutMs) {
                        user.log(`‚è∞ –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ${targetState}`, 'warning');
                        reject(new Error(`–¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ${targetState}`));
                    } else {
                        setTimeout(checkState, 500); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 500–º—Å
                    }
                };
                
                checkState();
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è answer (WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)
        async function waitForAnswer(user, timeoutMs = 10000) {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                
                const checkAnswer = () => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (–µ—Å—Ç—å remote stream)
                    const videoId = user.id === user1.id ? 'remoteVideo1' : 'remoteVideo2';
                    const remoteVideo = document.getElementById(videoId);
                    
                    if (remoteVideo && remoteVideo.srcObject && user.state === 'calling') {
                        user.log(`‚úÖ Answer –ø–æ–ª—É—á–µ–Ω, WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`, 'success');
                        resolve();
                    } else if (Date.now() - startTime > timeoutMs) {
                        user.log(`‚è∞ –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è answer`, 'warning');
                        reject(new Error(`–¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è answer`));
                    } else {
                        setTimeout(checkAnswer, 500); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 500–º—Å
                    }
                };
                
                checkAnswer();
            });
        }
        
        async function checkWebRTCSignals(user) {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            if (user.checkingWebRTCSignals) {
                return;
            }
            user.checkingWebRTCSignals = true;
            
            try {
                const url = `${SIGNALING_SERVER}?action=signals&userId=${user.id}&since=${user.lastSignalId}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.signals && data.signals.length > 0) {
                    const newSignals = data.signals.filter(signal => {
                        const signalTimestamp = signal.timestamp || signal.id;
                        return signalTimestamp > user.lastSignalId;
                    });
                    
                    if (newSignals.length > 0) {
                        newSignals.forEach(signal => {
                            user.lastSignalId = Math.max(user.lastSignalId, signal.timestamp || signal.id);
                            
                            if (signal.type === 'offer') {
                                user.log(`üì• –ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${signal.from}`, 'warning');
                                handleOffer(user, signal);
                            } else if (signal.type === 'answer') {
                                user.log(`üì• –ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${signal.from}`, 'warning');
                                handleAnswer(user, signal);
                            } else if (signal.type === 'ice-candidate') {
                                handleIceCandidate(user, signal);
                            }
                        });
                        
                        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
                        await deleteProcessedSignals(user);
                    }
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ WebRTC —Å–∏–≥–Ω–∞–ª–æ–≤: ${error.message}`, 'error');
            } finally {
                user.checkingWebRTCSignals = false;
            }
        }
        
        async function deleteProcessedSignals(user) {
            try {
                const url = `${SIGNALING_SERVER}?action=delete&userId=${user.id}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    user.log(`üóëÔ∏è –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã —É–¥–∞–ª–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞`, 'info');
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤: ${error.message}`, 'error');
            }
        }
        
        async function checkSignals(user) {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            if (user.checkingSignals) {
                return;
            }
            user.checkingSignals = true;
            
            user.log(`üîç checkSignals –¥–ª—è ${user.id}, —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'info');
            
            try {
                const url = `${SIGNALING_SERVER}?action=signals&userId=${user.id}&since=${user.lastSignalId}`;
                user.log(`üîç –ó–∞–ø—Ä–æ—Å: ${url}`, 'info');
                
                const response = await fetch(url);
                const data = await response.json();
                
                user.log(`üì° –û—Ç–≤–µ—Ç: ${JSON.stringify(data)}`, 'info');
                
                if (data.success && data.signals && data.signals.length > 0) {
                    user.log(`üì® –ü–æ–ª—É—á–µ–Ω–æ ${data.signals.length} —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï —Å–∏–≥–Ω–∞–ª—ã (–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
                    const newSignals = data.signals.filter(signal => {
                        const signalTimestamp = signal.timestamp || signal.id;
                        const isNew = signalTimestamp > user.lastSignalId;
                        if (!isNew) {
                            user.log(`‚è∞ –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–π —Å–∏–≥–Ω–∞–ª: ${signal.type} –æ—Ç ${signal.from} (timestamp: ${signalTimestamp} <= ${user.lastSignalId})`, 'warning');
                        }
                        return isNew;
                    });
                    
                    if (newSignals.length === 0) {
                        user.log(`üîç –í—Å–µ —Å–∏–≥–Ω–∞–ª—ã —Å—Ç–∞—Ä—ã–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º`, 'info');
                        // –û–±–Ω–æ–≤–ª—è–µ–º lastSignalId –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
                        const maxTimestamp = Math.max(...data.signals.map(s => s.timestamp || s.id));
                        user.lastSignalId = Math.max(user.lastSignalId, maxTimestamp);
                        return;
                    }
                    
                    user.log(`üì® –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ${newSignals.length} –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
                    
                    for (const signal of newSignals) {
                        user.lastSignalId = Math.max(user.lastSignalId, signal.timestamp || signal.id);
                        user.log(`üì® ${signal.type} –æ—Ç ${signal.from}`, 'success');
                        
                        if (signal.type === 'ping') {
                            if (user.state === 'idle') {
                                user.log(`üèì –ü–æ–ª—É—á–µ–Ω ping –æ—Ç ${signal.from} - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º pong`, 'warning');
                                user.state = 'connecting';
                                user.targetUser = signal.from;
                                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'info');
                                
                                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º pong –∏ –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                                try {
                                    await sendSignal(user, signal.from, 'pong', { received: true });
                                    user.log(`‚úÖ Pong –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                                    
                                    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
                                    setTimeout(() => checkSignals(user), 100);
                                } catch (error) {
                                    user.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ pong: ${error.message}`, 'error');
                                }
                                
                                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ connected –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ pong
                                user.state = 'connected';
                                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'success');
                                user.log(`üîó P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è WebRTC!`, 'success');
                                
                                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å checkSignals –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è disconnect —Å–∏–≥–Ω–∞–ª–æ–≤
                                // user.interval —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å checkSignals
                                user.log(`üîÑ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º polling –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è disconnect —Å–∏–≥–Ω–∞–ª–æ–≤`, 'info');
                                
                                updateAllCallButtons();
                            } else {
                                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ping –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'warning');
                            }
                        } else if (signal.type === 'pong') {
                            if (user.state === 'connecting' && user.targetUser === signal.from) {
                                user.log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} - —Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!`, 'success');
                                user.state = 'connected';
                                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'success');
                                user.log(`üîó P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è WebRTC!`, 'success');
                                user.log(`üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫" –¥–ª—è WebRTC`, 'info');
                                
                                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å checkSignals –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è disconnect —Å–∏–≥–Ω–∞–ª–æ–≤
                                // user.interval —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å checkSignals
                                user.log(`üîÑ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º polling –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è disconnect —Å–∏–≥–Ω–∞–ª–æ–≤`, 'info');
                                
                                updateAllCallButtons();
                            } else if (user.state === 'connected' && user.targetUser === signal.from) {
                                user.log(`üèì –ü–æ–ª—É—á–µ–Ω pong –æ—Ç ${signal.from} - —Å–≤—è–∑—å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞`, 'info');
                            } else {
                                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º pong –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}, –æ–∂–∏–¥–∞–ª–∏: ${user.targetUser}`, 'warning');
                            }
                        } else if (signal.type === 'offer') {
                            user.log(`üì• –ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${signal.from}`, 'warning');
                            handleOffer(user, signal);
                        } else if (signal.type === 'answer') {
                            user.log(`üì• –ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${signal.from}`, 'warning');
                            handleAnswer(user, signal);
                        } else if (signal.type === 'ice-candidate') {
                            handleIceCandidate(user, signal);
                        }
                    }
                    
                    // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
                    await deleteProcessedSignals(user);
                } else {
                    user.log(`üîç –ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤`, 'info');
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, 'error');
            } finally {
                user.checkingSignals = false;
            }
        }
        
        function updateCallButtons(user) {
            if (user.id === 'user1') {
                const startCallBtn = document.getElementById('startCallBtn1');
                const offerBtn = document.getElementById('offerBtn1');
                const p2pBtn = document.getElementById('p2pBtn1');
                const disconnectBtn = document.getElementById('disconnectBtn1');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (user.state === 'idle') {
                    // –í —Å–æ—Å—Ç–æ—è–Ω–∏–∏ idle –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    startCallBtn.style.display = 'inline-block';
                    startCallBtn.disabled = false;
                    offerBtn.style.display = 'none';
                    p2pBtn.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                } else if (user.state === 'connected') {
                    // –ü–æ—Å–ª–µ ping-pong –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫" —Ç–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É
                    if (globalInitiator === user.id) {
                        startCallBtn.style.display = 'none';
                    offerBtn.style.display = 'inline-block';
                    offerBtn.disabled = false;
                        p2pBtn.style.display = 'none';
                        disconnectBtn.style.display = 'none';
                    } else {
                        // –ù–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                        startCallBtn.style.display = 'none';
                        offerBtn.style.display = 'none';
                        p2pBtn.style.display = 'none';
                        disconnectBtn.style.display = 'none';
                    }
                } else if (user.state === 'calling') {
                    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ offer/answer –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–≤—è–∑—å" —Ç–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É
                    if (globalInitiator === user.id) {
                        startCallBtn.style.display = 'none';
                        offerBtn.style.display = 'none';
                        p2pBtn.style.display = 'inline-block';
                        p2pBtn.disabled = false;
                    disconnectBtn.style.display = 'inline-block';
                    disconnectBtn.disabled = false;
                } else {
                        // –ù–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É disconnect
                        startCallBtn.style.display = 'none';
                    offerBtn.style.display = 'none';
                        p2pBtn.style.display = 'none';
                        disconnectBtn.style.display = 'inline-block';
                        disconnectBtn.disabled = false;
                    }
                } else {
                    startCallBtn.style.display = 'none';
                    offerBtn.style.display = 'none';
                    p2pBtn.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                }
            } else if (user.id === 'user2') {
                const startCallBtn = document.getElementById('startCallBtn2');
                const offerBtn = document.getElementById('offerBtn2');
                const p2pBtn = document.getElementById('p2pBtn2');
                const disconnectBtn = document.getElementById('disconnectBtn2');
                const autoAnswerInfo = document.getElementById('autoAnswerInfo');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (user.state === 'idle') {
                    // –í —Å–æ—Å—Ç–æ—è–Ω–∏–∏ idle –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    startCallBtn.style.display = 'inline-block';
                    startCallBtn.disabled = false;
                    offerBtn.style.display = 'none';
                    p2pBtn.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                    autoAnswerInfo.style.display = 'none';
                } else if (user.state === 'connected') {
                    // –ü–æ—Å–ª–µ ping-pong –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫" —Ç–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É
                    if (globalInitiator === user.id) {
                        startCallBtn.style.display = 'none';
                    offerBtn.style.display = 'inline-block';
                    offerBtn.disabled = false;
                        p2pBtn.style.display = 'none';
                        disconnectBtn.style.display = 'none';
                        autoAnswerInfo.style.display = 'none';
                    } else {
                        // –ù–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ-answer info
                        startCallBtn.style.display = 'none';
                        offerBtn.style.display = 'none';
                        p2pBtn.style.display = 'none';
                        disconnectBtn.style.display = 'none';
                    autoAnswerInfo.style.display = 'block';
                    }
                } else if (user.state === 'calling') {
                    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ offer/answer –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–≤—è–∑—å" —Ç–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É
                    if (globalInitiator === user.id) {
                        startCallBtn.style.display = 'none';
                        offerBtn.style.display = 'none';
                        p2pBtn.style.display = 'inline-block';
                        p2pBtn.disabled = false;
                        disconnectBtn.style.display = 'inline-block';
                        disconnectBtn.disabled = false;
                        autoAnswerInfo.style.display = 'none';
                } else {
                        // –ù–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É disconnect
                        startCallBtn.style.display = 'none';
                    offerBtn.style.display = 'none';
                        p2pBtn.style.display = 'none';
                        disconnectBtn.style.display = 'inline-block';
                        disconnectBtn.disabled = false;
                        autoAnswerInfo.style.display = 'none';
                    }
                } else {
                    startCallBtn.style.display = 'none';
                    offerBtn.style.display = 'none';
                    p2pBtn.style.display = 'none';
                    disconnectBtn.style.display = 'none';
                    autoAnswerInfo.style.display = 'none';
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateAllCallButtons() {
            updateCallButtons(user1);
            updateCallButtons(user2);
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ PeerConnection
        function setupPeerConnectionHandlers(user) {
            user.peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ICE candidate —á–µ—Ä–µ–∑ signaling —Å–µ—Ä–≤–µ—Ä
                    fetch(SIGNALING_SERVER, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'signal',
                            from: user.id,
                            to: user.targetUser,
                            type: 'ice-candidate',
                            data: event.candidate
                        })
                    }).then(response => response.json())
                      .then(result => user.log(`üì§ ICE candidate –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${JSON.stringify(result)}`, 'info'))
                      .catch(error => user.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ICE candidate: ${error.message}`, 'error'));
                }
            };
            
            user.peerConnection.ontrack = (event) => {
                user.log('üìπ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫', 'success');
                const remoteVideo = document.getElementById(`remoteVideo${user.id === user1.id ? '1' : '2'}`);
                remoteVideo.srcObject = event.streams[0];
            };
            
            user.peerConnection.onconnectionstatechange = () => {
                user.log(`üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${user.peerConnection.connectionState}`, 'info');
                if (user.peerConnection.connectionState === 'connected') {
                    user.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                } else if (user.peerConnection.connectionState === 'failed') {
                    user.log('‚ùå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å', 'error');
                    } else if (user.peerConnection.connectionState === 'disconnected') {
                        if (!isResetting) {
                            user.log('üîå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ onconnectionstatechange', 'warning');
                            isResetting = true;
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                            resetUser1();
                            resetUser2();
                            globalInitiator = null;
                            updateAllCallButtons();
                            isResetting = false;
                            user.log('‚úÖ –°–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω —á–µ—Ä–µ–∑ onconnectionstatechange', 'success');
                            
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                            user1.log('üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ user1 —á–µ—Ä–µ–∑ onconnectionstatechange...', 'info');
                            user2.log('üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ user2 —á–µ—Ä–µ–∑ onconnectionstatechange...', 'info');
                            
                            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
                            setTimeout(() => {
                                startUser(user1, 'user1Id', 'localVideo1');
                                startUser(user2, 'user2Id', 'localVideo2');
                            }, 1000);
                        } else {
                            user.log('üîå P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ - —Å–±—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ disconnectCall', 'info');
                        }
                    }
            };
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ WebRTC —Å–∏–≥–Ω–∞–ª–æ–≤
        async function handleOffer(user, signal) {
            if (user.state !== 'connected' && user.state !== 'calling') {
                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º offer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'warning');
                return;
            }

            user.log(`üì• –ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${signal.from}`, 'warning');
            user.log(`üì• Offer –¥–∞–Ω–Ω—ã–µ: type=${signal.data.type}, sdp –¥–ª–∏–Ω–∞=${signal.data.sdp ? signal.data.sdp.length : 'undefined'}`, 'info');
            
            try {
                // –°–æ–∑–¥–∞–µ–º PeerConnection –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!user.peerConnection) {
                    user.peerConnection = new RTCPeerConnection(rtcConfig);
                    setupPeerConnectionHandlers(user);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!user.localStream) {
                    user.localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                    const localVideo = document.getElementById(`localVideo${user.id === user1.id ? '1' : '2'}`);
                    localVideo.srcObject = user.localStream;
                    
                    user.log('üìπ –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω', 'success');
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∫ PeerConnection
                if (user.localStream) {
                    user.localStream.getTracks().forEach(track => {
                        user.peerConnection.addTrack(track, user.localStream);
                    });
                    user.log('üì§ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ PeerConnection', 'info');
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await user.peerConnection.setRemoteDescription(signal.data);
                
                // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º answer
                const answer = await user.peerConnection.createAnswer();
                await user.peerConnection.setLocalDescription(answer);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer —á–µ—Ä–µ–∑ signaling —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: user.id,
                        to: signal.from,
                        type: 'answer',
                        data: answer
                    })
                });
                
                const result = await response.json();
                user.log(`üì§ Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${JSON.stringify(result)}`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                user.state = 'calling';
                updateAllCallButtons();
                
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${error.message}`, 'error');
            }
        }
        
        async function handleAnswer(user, signal) {
            if (user.state !== 'calling') {
                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º answer - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'warning');
                return;
            }

            user.log(`üì• –ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${signal.from}`, 'warning');
            user.log(`üì• Answer –¥–∞–Ω–Ω—ã–µ: type=${signal.data.type}, sdp –¥–ª–∏–Ω–∞=${signal.data.sdp ? signal.data.sdp.length : 'undefined'}`, 'info');
            
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
                await user.peerConnection.setRemoteDescription(signal.data);
            user.log(`‚úÖ Offer/Answer –æ–±–º–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!`, 'success');
            
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º polling –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É disconnect —Å–∏–≥–Ω–∞–ª–æ–≤
            if (user.interval) {
                clearInterval(user.interval);
                user.interval = null;
                user.log(`‚èπÔ∏è Polling –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`, 'info');
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º polling –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ disconnect —Å–∏–≥–Ω–∞–ª–æ–≤
                user.interval = setInterval(() => checkSignals(user), 3000);
                user.log(`üîÑ –ó–∞–ø—É—â–µ–Ω polling –¥–ª—è disconnect —Å–∏–≥–Ω–∞–ª–æ–≤`, 'info');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è offer/answer –æ–±–º–µ–Ω–∞
                updateAllCallButtons();
                
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer: ${error.message}`, 'error');
            }
        }
        
        async function handleIceCandidate(user, signal) {
            if (user.state !== 'calling') {
                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}`, 'warning');
                return;
            }
            
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –∫ PeerConnection
                await user.peerConnection.addIceCandidate(signal.data);
                user.log(`üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç ${signal.from}`, 'info');
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`, 'error');
            }
        }

        function handleDisconnect(user, signal) {
            user.log(`üîç –û—Ç–ª–∞–¥–∫–∞ handleDisconnect: user.state=${user.state}, user.targetUser=${user.targetUser}, signal.from=${signal.from}`, 'info');
            user.log(`üì• –ü–æ–ª—É—á–µ–Ω disconnect —Å–∏–≥–Ω–∞–ª –æ—Ç ${signal.from}`, 'warning');
            
            if ((user.state === 'connected' || user.state === 'calling') && user.targetUser === signal.from) {
                user.log(`üîå –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª —Ä–∞–∑—Ä—ã–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç ${signal.from}`, 'warning');
                user.log(`üìä –ü—Ä–∏—á–∏–Ω–∞: ${signal.data.reason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}`, 'info');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º PeerConnection
                if (user.peerConnection) {
                    user.peerConnection.close();
                    user.peerConnection = null;
                    user.log(`üîå PeerConnection –∑–∞–∫—Ä—ã—Ç`, 'info');
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                if (user.localStream) {
                    user.localStream.getTracks().forEach(track => track.stop());
                    user.localStream = null;
                    user.log(`üìπ –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`, 'info');
                }
                
                // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
                const localVideo = document.getElementById(`localVideo${user.id === user1.id ? '1' : '2'}`);
                const remoteVideo = document.getElementById(`remoteVideo${user.id === user1.id ? '1' : '2'}`);
                localVideo.srcObject = null;
                remoteVideo.srcObject = null;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user.state = 'idle';
                user.targetUser = null;
                globalInitiator = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
                user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'info');
                user.log(`üîÑ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ, –≤–æ–∑–≤—Ä–∞—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                updateAllCallButtons();
            } else {
                user.log(`‚ö†Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º disconnect –æ—Ç ${signal.from} - —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user.state}, –æ–∂–∏–¥–∞–ª–∏: ${user.targetUser}`, 'warning');
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ answer
        async function sendTestAnswer(user, toUserId) {
            const startTime = Date.now();
            try {
                user.log(`üì§ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ answer –∫ ${toUserId}`, 'warning');
                
                const testAnswer = {
                    type: 'answer',
                    sdp: 'v=0\r\no=- 1234567890 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0\r\nm=audio 9 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:test\r\na=ice-pwd:test\r\na=fingerprint:sha-256 test\r\na=setup:active\r\na=mid:0\r\na=sendrecv\r\na=rtpmap:111 opus/48000/2\r\n'
                };

                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: user.id,
                        to: toUserId,
                        type: 'answer',
                        data: testAnswer
                    })
                });

                const result = await response.json();
                const sendTime = Date.now() - startTime;
                if (result.success) {
                    user.log(`‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ (${sendTime}–º—Å)`, 'success');
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ calling –¥–ª—è user2
                    user.state = 'calling';
                    user.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: ${user.state}`, 'info');
                    updateAllCallButtons();
                } else {
                    user.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ answer: ${result.error}`, 'error');
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function sendSignal(user, to, type, data) {
            try {
                user.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${type} –∫ ${to}`, 'warning');
                
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: user.id,
                        to: to,
                        type: type,
                        data: data
                    })
                });
                
                const result = await response.json();
                user.log(`üì° –û—Ç–≤–µ—Ç: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    user.log(`‚úÖ ${type} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                } else {
                    user.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${result.message}`, 'error');
                }
            } catch (error) {
                user.log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        function resetUser1() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling
            if (user1.interval) {
                clearInterval(user1.interval);
                user1.interval = null;
            }
            
            if (user1.peerConnection) {
                user1.peerConnection.close();
                user1.peerConnection = null;
            }
            
            if (user1.localStream) {
                user1.localStream.getTracks().forEach(track => track.stop());
                user1.localStream = null;
            }
            
            user1.state = 'idle';
            user1.targetUser = null;
            user1.log(`‚úÖ user1 —Å–±—Ä–æ—à–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user1.state}`, 'success');
            // globalInitiator –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ disconnectCall
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" –¥–ª—è —Å–±—Ä–æ—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('startCallBtn1').style.display = 'inline-block';
            document.getElementById('startCallBtn1').disabled = false;
            document.getElementById('offerBtn1').style.display = 'none';
            document.getElementById('offerBtn1').disabled = true;
            document.getElementById('p2pBtn1').style.display = 'none';
            document.getElementById('p2pBtn1').disabled = true;
            document.getElementById('disconnectBtn1').style.display = 'none';
            document.getElementById('disconnectBtn1').disabled = true;
            
            document.getElementById('localVideo1').srcObject = null;
            document.getElementById('remoteVideo1').srcObject = null;
            
            user1.log('üîÑ User 1 —Å–±—Ä–æ—à–µ–Ω', 'warning');
            updateAllCallButtons();
        }
        
        function resetUser2() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling
            if (user2.interval) {
                clearInterval(user2.interval);
                user2.interval = null;
            }
            
            if (user2.peerConnection) {
                user2.peerConnection.close();
                user2.peerConnection = null;
            }
            
            if (user2.localStream) {
                user2.localStream.getTracks().forEach(track => track.stop());
                user2.localStream = null;
            }
            
            user2.state = 'idle';
            user2.targetUser = null;
            user2.log(`‚úÖ user2 —Å–±—Ä–æ—à–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${user2.state}`, 'success');
            // globalInitiator –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ disconnectCall
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" –¥–ª—è —Å–±—Ä–æ—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('startCallBtn2').style.display = 'inline-block';
            document.getElementById('startCallBtn2').disabled = false;
            document.getElementById('offerBtn2').style.display = 'none';
            document.getElementById('offerBtn2').disabled = true;
            document.getElementById('p2pBtn2').style.display = 'none';
            document.getElementById('p2pBtn2').disabled = true;
            document.getElementById('answerBtn2').style.display = 'none';
            document.getElementById('answerBtn2').disabled = true;
            
            document.getElementById('localVideo2').srcObject = null;
            document.getElementById('remoteVideo2').srcObject = null;
            
            user2.log('üîÑ User 2 —Å–±—Ä–æ—à–µ–Ω', 'warning');
            updateAllCallButtons();
        }
        
        async function disconnectCall() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–¥–µ—Ç –ª–∏ —É–∂–µ —Å–±—Ä–æ—Å
            if (isResetting) {
                user1.log(`‚ö†Ô∏è –°–±—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è`, 'warning');
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ç–æ –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É disconnect
            let caller = null;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (user1.state === 'calling' && user1.targetUser) {
                caller = user1;
            } else if (user2.state === 'calling' && user2.targetUser) {
                caller = user2;
            }
            
            if (!caller) {
                user1.log(`‚ö†Ô∏è –ù–µ –º–æ–≥—É —Ä–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ - –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è`, 'warning');
                return;
            }
            
            caller.log(`üîå –†–∞–∑—Ä—ã–≤–∞–µ–º P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (${caller.id})`, 'warning');
            isResetting = true;
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º PeerConnection —É –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (caller.peerConnection) {
                caller.peerConnection.close();
                caller.peerConnection = null;
                caller.log(`üîå PeerConnection –∑–∞–∫—Ä—ã—Ç —É ${caller.id}`, 'info');
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º PeerConnection —É –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const otherUser = caller.id === 'user1' ? user2 : user1;
            if (otherUser.peerConnection) {
                otherUser.peerConnection.close();
                otherUser.peerConnection = null;
                otherUser.log(`üîå PeerConnection –∑–∞–∫—Ä—ã—Ç —É ${otherUser.id}`, 'info');
            }
            
            // –û—á–∏—â–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                user1.log('üßπ –û—á–∏—Å—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...', 'info');
                
            try {
                // –û—á–∏—â–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è user1
                const response1 = await fetch(`${SIGNALING_SERVER}?action=delete&userId=${user1.id}`);
                const result1 = await response1.json();
                user1.log(`üì° –û—á–∏—Å—Ç–∫–∞ ${user1.id}: ${JSON.stringify(result1)}`, 'info');
                
                // –û—á–∏—â–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è user2
                const response2 = await fetch(`${SIGNALING_SERVER}?action=delete&userId=${user2.id}`);
                const result2 = await response2.json();
                user2.log(`üì° –û—á–∏—Å—Ç–∫–∞ ${user2.id}: ${JSON.stringify(result2)}`, 'info');
                
                user1.log('‚úÖ –í—Å–µ —Å–∏–≥–Ω–∞–ª—ã –æ—á–∏—â–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', 'success');
                user2.log('‚úÖ –í—Å–µ —Å–∏–≥–Ω–∞–ª—ã –æ—á–∏—â–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', 'success');
            } catch (error) {
                user1.log(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤: ${error.message}`, 'error');
                user2.log(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤: ${error.message}`, 'error');
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            user1.log('üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ user1 —á–µ—Ä–µ–∑ disconnectCall', 'info');
            user2.log('üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ user2 —á–µ—Ä–µ–∑ disconnectCall', 'info');
            resetUser1();
            resetUser2();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
            globalInitiator = null;
            user1.log('üîÑ globalInitiator —Å–±—Ä–æ—à–µ–Ω', 'info');
            user2.log('üîÑ globalInitiator —Å–±—Ä–æ—à–µ–Ω', 'info');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ idle
            user1.log(`‚úÖ user1.state = ${user1.state}`, 'success');
            user2.log(`‚úÖ user2.state = ${user2.state}`, 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            updateAllCallButtons();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–±—Ä–æ—Å–∞
            isResetting = false;
            user1.log('‚úÖ –°–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω —á–µ—Ä–µ–∑ disconnectCall', 'success');
            user2.log('‚úÖ –°–±—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω —á–µ—Ä–µ–∑ disconnectCall', 'success');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            user1.log('üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ user1...', 'info');
            user2.log('üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ user2...', 'info');
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
            setTimeout(() => {
                startUser(user1, 'user1Id', 'localVideo1');
                startUser(user2, 'user2Id', 'localVideo2');
            }, 1000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function resetBothUsers() {
            if (isResetting) {
                user1.log(`‚ö†Ô∏è –°–±—Ä–æ—Å —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è`, 'warning');
                return;
            }
            
            user1.log('üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'info');
            isResetting = true;
            resetUser1();
            resetUser2();
            globalInitiator = null;
            updateAllCallButtons();
            isResetting = false;
            user1.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–±—Ä–æ—à–µ–Ω–æ', 'success');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async function startP2PCall() {
            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞)
                const activeUser = globalInitiator === user1.id ? user1 : user2;
                const targetUser = { id: activeUser.targetUser };
                
                activeUser.log('üìû –ê–∫—Ç–∏–≤–∞—Ü–∏—è P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...', 'info');
                
                // –°–æ–∑–¥–∞–µ–º PeerConnection –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!activeUser.peerConnection) {
                    activeUser.peerConnection = new RTCPeerConnection(rtcConfig);
                    setupPeerConnectionHandlers(activeUser);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!activeUser.localStream) {
                    activeUser.localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                    const localVideo = document.getElementById(`localVideo${activeUser.id === user1.id ? '1' : '2'}`);
                    localVideo.srcObject = activeUser.localStream;
                    
                    activeUser.log('üìπ –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω', 'success');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ —Ç—Ä–µ–∫–∏
                if (activeUser.localStream && activeUser.peerConnection.getSenders().length === 0) {
                    activeUser.localStream.getTracks().forEach(track => {
                        activeUser.peerConnection.addTrack(track, activeUser.localStream);
                    });
                    activeUser.log('üì§ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ PeerConnection', 'info');
                } else {
                    activeUser.log('üì§ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ PeerConnection', 'info');
                }
                
                // –°–æ–∑–¥–∞–µ–º offer –¥–ª—è P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                const offer = await activeUser.peerConnection.createOffer();
                await activeUser.peerConnection.setLocalDescription(offer);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º offer —á–µ—Ä–µ–∑ signaling —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(SIGNALING_SERVER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'signal',
                        from: activeUser.id,
                        to: targetUser.id,
                        type: 'offer',
                        data: offer
                    })
                });
                
                const result = await response.json();
                activeUser.log(`üì§ P2P Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${JSON.stringify(result)}`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                activeUser.state = 'calling';
                updateAllCallButtons();
                
            } catch (error) {
                const activeUser = user1.state === 'calling' ? user1 : user2;
                activeUser.log(`‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ P2P: ${error.message}`, 'error');
            }
        }
        
        function copyAllLogs() {
            const log1 = document.getElementById('log1').innerText;
            const log2 = document.getElementById('log2').innerText;
            const allLogs = `=== –õ–û–ì–ò USER 1 ===\n${log1}\n\n=== –õ–û–ì–ò USER 2 ===\n${log2}\n\n=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–ï–°–¢–ï ===\n–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞: ${new Date().toLocaleString()}\n–°–µ—Ä–≤–µ—Ä: ${SIGNALING_SERVER}\nUser 1 ID: ${user1.id}\nUser 2 ID: ${user2.id}`;
            
            navigator.clipboard.writeText(allLogs).then(() => {
                alert('–õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            });
        }
    </script>
</body>
</html>

