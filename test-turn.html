<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç TURN —Å–µ—Ä–≤–µ—Ä–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
    </style>
</head>
<body>
    <h1>üßä –¢–µ—Å—Ç TURN —Å–µ—Ä–≤–µ—Ä–∞ VK Cloud</h1>
    
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }
        
        async function testTURN() {
            addResult('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º TURN —Å–µ—Ä–≤–µ—Ä VK Cloud...', 'info');
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addResult('‚úÖ –ú–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã', 'success');
                
                // –°–æ–∑–¥–∞–µ–º peer connection —Å TURN —Å–µ—Ä–≤–µ—Ä–æ–º
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { 
                            urls: 'turn:62.84.126.200:3478', 
                            username: 'webrtc', 
                            credential: 'password123' 
                        },
                        { 
                            urls: 'turns:62.84.126.200:3479', 
                            username: 'webrtc', 
                            credential: 'password123' 
                        }
                    ]
                });
                
                addResult('‚úÖ Peer connection —Å–æ–∑–¥–∞–Ω —Å TURN —Å–µ—Ä–≤–µ—Ä–æ–º', 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                stream.getTracks().forEach(track => {
                    pc.addTrack(track, stream);
                });
                
                addResult('‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                
                // –°–æ–∑–¥–∞–µ–º offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                addResult('‚úÖ Offer —Å–æ–∑–¥–∞–Ω', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                let iceCandidates = 0;
                let turnCandidates = 0;
                let stunCandidates = 0;
                let hostCandidates = 0;
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        iceCandidates++;
                        const candidate = event.candidate.candidate;
                        
                        if (candidate.includes('typ relay')) {
                            turnCandidates++;
                            addResult(`üßä TURN –∫–∞–Ω–¥–∏–¥–∞—Ç ${turnCandidates}: ${candidate}`, 'success');
                        } else if (candidate.includes('typ srflx')) {
                            stunCandidates++;
                            addResult(`üßä STUN –∫–∞–Ω–¥–∏–¥–∞—Ç ${stunCandidates}: ${candidate}`, 'info');
                        } else if (candidate.includes('typ host')) {
                            hostCandidates++;
                            addResult(`üßä Host –∫–∞–Ω–¥–∏–¥–∞—Ç ${hostCandidates}: ${candidate}`, 'info');
                        } else {
                            addResult(`üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç ${iceCandidates}: ${candidate}`, 'info');
                        }
                    } else {
                        addResult(`‚úÖ ICE gathering –∑–∞–≤–µ—Ä—à–µ–Ω`, 'success');
                        addResult(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í—Å–µ–≥–æ ${iceCandidates}, Host ${hostCandidates}, STUN ${stunCandidates}, TURN ${turnCandidates}`, 'info');
                        
                        if (turnCandidates === 0) {
                            addResult('‚ùå TURN –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã - TURN —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                        } else {
                            addResult('‚úÖ TURN –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã - TURN —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
                        }
                    }
                };
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                pc.oniceconnectionstatechange = () => {
                    addResult(`üîÑ ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${pc.iceConnectionState}`, 'info');
                };
                
                pc.onconnectionstatechange = () => {
                    addResult(`üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${pc.connectionState}`, 'info');
                };
                
                // –ñ–¥–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                setTimeout(() => {
                    if (iceCandidates === 0) {
                        addResult('‚ùå ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã - –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é', 'error');
                    }
                }, 10000);
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
        window.addEventListener('load', testTURN);
    </script>
</body>
</html>
