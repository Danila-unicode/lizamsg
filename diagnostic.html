<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebRTC</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebRTC</h1>
    
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }
        
        async function testSignalingServer() {
            addResult('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∏–≥–Ω–∞–ª–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä...', 'info');
            
            try {
                const response = await fetch('https://functions.yandexcloud.net/d4ec0rusp5blvc9pucd4', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'test' })
                });
                
                const data = await response.json();
                addResult(`‚úÖ –°–∏–≥–Ω–∞–ª–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç: ${JSON.stringify(data)}`, 'success');
            } catch (error) {
                addResult(`‚ùå –°–∏–≥–Ω–∞–ª–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`, 'error');
            }
        }
        
        async function testWebRTC() {
            addResult('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º WebRTC...', 'info');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebRTC
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    addResult('‚ùå WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
                    return;
                }
                
                addResult('‚úÖ WebRTC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'success');
                
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫–∏
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addResult('‚úÖ –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω', 'success');
                
                // –°–æ–∑–¥–∞–µ–º peer connection
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { 
                            urls: 'turn:62.84.126.200:3478', 
                            username: 'webrtc', 
                            credential: 'password123' 
                        }
                    ]
                });
                
                addResult('‚úÖ Peer connection —Å–æ–∑–¥–∞–Ω', 'success');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                stream.getTracks().forEach(track => {
                    pc.addTrack(track, stream);
                });
                
                addResult('‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                
                // –°–æ–∑–¥–∞–µ–º offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                addResult('‚úÖ Offer —Å–æ–∑–¥–∞–Ω', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                let iceCandidates = 0;
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        iceCandidates++;
                        addResult(`üßä ICE –∫–∞–Ω–¥–∏–¥–∞—Ç ${iceCandidates}: ${event.candidate.candidate}`, 'info');
                    } else {
                        addResult(`‚úÖ ICE gathering –∑–∞–≤–µ—Ä—à–µ–Ω. –í—Å–µ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: ${iceCandidates}`, 'success');
                    }
                };
                
                // –ñ–¥–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
                setTimeout(() => {
                    if (iceCandidates === 0) {
                        addResult('‚ö†Ô∏è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã - –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å TURN —Å–µ—Ä–≤–µ—Ä–æ–º', 'warning');
                    }
                }, 5000);
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ WebRTC: ${error.message}`, 'error');
            }
        }
        
        async function testAuth() {
            addResult('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...', 'info');
            
            try {
                const response = await fetch('api/check_auth.php');
                const data = await response.json();
                
                if (data.success) {
                    addResult(`‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫: ${data.user.phone}`, 'success');
                } else {
                    addResult(`‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${data.message}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
        window.addEventListener('load', async () => {
            await testAuth();
            await testSignalingServer();
            await testWebRTC();
        });
    </script>
</body>
</html>
